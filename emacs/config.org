* General stuff

** Email
There are two needs:
1. Retrieving emails.
   - Which we'll solve using *internet message access protocol (IMAP)*.
2. Sending emails.
   - Which we'll solve using *simple mail transport protocol (SMTP)*.
3. An interface (in Emacs) that unifies the two.

*** Retrieving emails using =offlineimap=

**** Integration with different providers

***** Outlook

****** =davmail=
- Effectively functions as a local email server, handling everything between you and Outlook, e.g. authentication.

#+begin_src shell :results output :wrap "src conf"
less ~/.offlineimaprc
#+end_src

#+RESULTS:
#+begin_src conf
[general]
accounts = tor-erlend95,tef30,dcsa,tor-github
maxsyncaccounts = 4
# Path to file with arbitrary Python code to load.
pythonfile = ~/.offlineimap.py

[Account tef30]
localrepository = tef30-local
remoterepository = tef30-exchange
# postsynchook = $HOME/.local/bin/check-email

[Repository tef30-local]
type = Maildir
localfolders = $HOME/mail/tef30@cam.ac.uk
# TODO: This is too aggressive.
nametrans = lambda folder: folder.replace('sent', 'Sent Items')

[Repository tef30-exchange]
type = IMAP
ssl = no
remotehost = localhost
remoteport = 1143
remoteuser = tef30@cam.ac.uk
remotepass = asdfas # it's not actually used
# createFolders = False # don't create folders remotely
# readonly = yes
# TODO: This is too aggressive.
nametrans = lambda folder: folder.replace('Sent Items', 'sent')
folderfilter = lambda folder: "Hermes" not in folder

[Account dcsa]
localrepository = dcsa-local
remoterepository = dcsa-exchange
# postsynchook = $HOME/.local/bin/check-email

[Repository dcsa-local]
type = Maildir
localfolders = $HOME/mail/dcsa_coms@darwin.cam.ac.uk
# TODO: This is too aggressive.
nametrans = lambda folder: folder.replace('sent', 'Sent Items')

[Repository dcsa-exchange]
type = IMAP
ssl = no
remotehost = localhost
remoteport = 1143
remoteuser = tef30@cam.ac.uk/dcsa_coms@darwin.cam.ac.uk
remotepass = asdfas # it's not actually used
# This is really stupid.
folderfilter = lambda folder: '/users/dcsa_coms@darwin/cam/ac/uk/' not in folder
# createFolders = False # don't create folders remotely
# readonly = yes
# TODO: This is too aggressive.
nametrans = lambda folder: folder.replace('Sent Items', 'sent')

[Account tor-erlend95]
localrepository = tor-erlend95-local
remoterepository = tor-erlend95-remote
# postsynchook = $HOME/.local/bin/check-email

[Repository tor-erlend95-remote]
type = Gmail
remoteuser = tor.erlend95@gmail.com
remotepasseval = get_authinfo_password("smtp.gmail.com", "tor.erlend95@gmail.com", 587)
ssl = yes
sslcacertfile = OS-DEFAULT

[Repository tor-erlend95-local]
type = GmailMaildir
localfolders = $HOME/mail/tor.erlend95@gmail.com


[Account tor-github]
localrepository = tor-github-local
remoterepository = tor-github-remote
# postsynchook = $HOME/.local/bin/check-email

[Repository tor-github-remote]
type = Gmail
remoteuser = tor.github@gmail.com
remotepasseval = get_authinfo_password("smtp.gmail.com", "tor.github@gmail.com", 587)
ssl = yes
sslcacertfile = OS-DEFAULT

[Repository tor-github-local]
type = GmailMaildir
localfolders = $HOME/mail/tor.github@gmail.com
#+end_src

******* Setup

***** Gmail

**** Authentication
- Using =~/.authinfo= to store the passwords (this is also used by Emacs' SMTP functionality)
- Need some setup to make =offlineimap= work nicely with this.

#+begin_src python :tangle ~/.offlineimap.py
#!/usr/bin/env python2
import re, os, sys


def get_authinfo_password(machine, login, port):
    "Extracts password from `~/.authinfo` for a given `machine`, `login`, `port` combination."
    s = "machine %s login %s port %s password (.*)$" % (machine, login, port)
    p = re.compile(s, flags=re.MULTILINE)
    # TODO: Use encrypted `.authinfo`.
    # authinfo = os.popen("gpg -q --no-tty -d ~/.authinfo.gpg").read()
    with open("/home/tor/.authinfo", "r") as f:
        authinfo = f.read()

    return p.search(authinfo).group(1)


if __name__ == "__main__":
    # Useful for testing.
    print(get_authinfo_password(sys.argv[1], sys.argv[2], sys.argv[3]))
#+end_src

And then we need to load this file in our =.offlineimaprc=:

#+begin_src shell :results output :wrap src conf :eval no :exports output
sed -n "1,5p" ~/.offlineimaprc
#+end_src

#+RESULTS:
#+begin_src conf
[general]
...
# Path to file with arbitrary Python code to load.
pythonfile = ~/.offlineimap.py
#+end_src

Now we can use the =remotepasseval= setting for the remote repositories to extract the auth info:

#+begin_src conf :eval no :exports code
# NOTE: Usually here we should be using `imap.gmail.com`, but we'll be needing the same auth info for SMTP so might as well just re-use
# rather than having multiple entries with the same info in the `~/.authinfo`.
remotepasseval = get_authinfo_password("smtp.gmail.com", "tor.github@gmail.com", 587)
#+end_src

#+begin_warning
Some sources on the interwebs says to use =remotepass= in the above, but that doesn't seem to work. 
#+end_warning

*** Interfacing with emails using =notmuch=
- Provides a simple and powerful tagging system
- Treats everything as a single big "inbox", allowing us to easily filter based on different tags.
  - Personally find this very useful due to all the different email accounts I manage.



* =init.el= v2
:PROPERTIES:
:header-args: emacs-lisp: :tangle init-new.el :comments link
:END:
** Basic
#+begin_src emacs-lisp
(defun not-nil-p (x)
  "Return `t` if X is not nil."
  (not (not x)))

;; Customize user interface.
(menu-bar-mode 0)
(tool-bar-mode 0)
(scroll-bar-mode 0)

(setq inhibit-startup-screen t)
(column-number-mode)

;; Don't show trailing whitespace _always_. It's annoying.
(setq-default show-trailing-whitespace nil)
(setq-default indicate-empty-lines t)
(setq-default indicate-buffer-boundaries 'left)

;; Consider a period followed by a single space to be end of sentence.
(setq sentence-end-double-space nil)

;; Use spaces, not tabs, for indentation.
(setq-default indent-tabs-mode nil)

;; Display the distance between two tab stops as 4 characters wide.
(setq-default tab-width 4)

;; Indentation setting for various languages.
(setq c-basic-offset 4)
(setq js-indent-level 2)
(setq css-indent-offset 2)

;; Highlight matching pairs of parentheses.
(setq show-paren-delay 0)
(show-paren-mode)

;; Move the point to bottom/top when using `C-v' and `M-v', respectively,
;; rather than just trying to scroll.
(setq scroll-error-top-bottom t)

;; Disable blinking cursor.
(setq-default visible-cursor nil)
;; (blink-cursor-mode 0) ;; Should be unnecessary on Emacs >24?
#+end_src

*** Make =format-time-string= consistent across OS time settings
#+begin_src emacs-lisp :results none
;; Ensures that we're always going to format the string according to EN locale.
;; Setting `system-time-locale' to `"C"' or something doesn't work for daemon-mode.
;; This is copy-paste from https://kisaragi-hiu.com/blog/2019-10-09-format-time-string-today.html.
(require 'calendar)
(defun kisaragi/english-dow (&optional time zone abbreviated)
  "Return ABBREVIATED name of the day of week at TIME and ZONE.

If TIME or ZONE is nil, use `current-time' or `current-time-zone'."
  (unless time (setq time (current-time)))
  (unless zone (setq zone (current-time-zone)))
  (calendar-day-name
   (pcase-let ((`(,_ ,_ ,_ ,d ,m ,y . ,_)
                (decode-time time zone)))
     (list m d y))
   abbreviated))

(defun kisaragi/advice-format-time-string (func format &optional time zone)
  "Pass FORMAT, TIME, and ZONE to FUNC.

Replace \"%A\" in FORMAT with English day of week of today,
\"%a\" with the abbreviated version."
  (let* ((format (replace-regexp-in-string "%a" (kisaragi/english-dow time zone t)
                                           format))
         (format (replace-regexp-in-string "%A" (kisaragi/english-dow time zone nil)
                                           format)))
    (funcall func format time zone)))


(advice-add 'format-time-string :around #'kisaragi/advice-format-time-string)
#+end_src

#+RESULTS:
** File backup
#+begin_src emacs-lisp
;; Write auto-saves and backups to separate directory.
(make-directory "~/.tmp/emacs/auto-save/" t)
(setq auto-save-file-name-transforms '((".*" "~/.tmp/emacs/auto-save/" t)))
(setq backup-directory-alist '(("." . "~/.tmp/emacs/backup/")))

;; Do not move the current file while creating backup.
(setq backup-by-copying t)

;; Disable lockfiles.
(setq create-lockfiles nil)
#+end_src

** Custom settings in seperate file
#+begin_src emacs-lisp
;; Write customizations to a separate file instead of this file.
(setq custom-file (expand-file-name "custom.el" user-emacs-directory))
(load custom-file t)
#+end_src

** Package management: =straight.el= and =use-package=
#+begin_src emacs-lisp
;; straight.el
(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 5))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
        (url-retrieve-synchronously
         "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
         'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))

(defun my/straight-installed-p (package)
  "Check if PACKAGE is installed (according to `straight.el')."
  (straight--installed-and-buildable-p
   ;; `format' allows us to handle both strings and symbols.
   (gethash (format "%s" package) straight--recipe-cache)))

;; use-package.el: Makes configuring the packages much easier.
(straight-use-package 'use-package)

;; Use `straight.el` by default when calling `use-package`.
(setq straight-use-package-by-default t)
#+end_src

*** Customizing =use-package=
#+begin_src emacs-lisp
;; Allow us to "require" system packages to be present using `:ensure-system-package'
;; in `use-package' blocks.
(use-package use-package-ensure-system-package)
#+end_src

** OS specific setup
#+begin_src emacs-lisp
;; Linux
(when (string-equal system-type "gnu/linux") ; linux
  (message "Performing Linux-specific setup...")
  (use-package exec-path-from-shell)
  (exec-path-from-shell-initialize)

  ;; use xclip to yank, allowing you to yank in terminal to the GLOBAL clipboard
  (use-package xclip
    :init (xclip-mode))
  )
#+end_src

** Compat.el
#+begin_src emacs-lisp
;; TODO: Restrict to v28.1.2.2 and use the `emacs-compat' remote, not the `emacs-straight' (which doesn't have tags)
(use-package compat)
#+end_src

** User interface
*** =M-x=
Personally I like =helm= as I find its discovery to be quite good.

#+begin_src emacs-lisp
;; helm.el: Provides a much more pleasant `M-x` experience. Alternative to `ido`.
(use-package helm
  :diminish helm-mode  ;; removes the helm-mode from the mode-line
  :init (progn
          (require 'helm-config)
          (helm-mode))
  :bind (("M-x" . helm-M-x)))

;; helm-descbinds.el: Adds mode
(use-package helm-descbinds
  :bind (("C-h b" . helm-descbinds)))
#+end_src

=which-key= improves discoverability of bindings further.

#+begin_src emacs-lisp
;; which-key.el: Provides suggestions/completions for keybindings upon use.
(use-package which-key
  :diminish which-key-mode ;; hide form mode-line
  :config (which-key-mode))
#+end_src
*** Fonts & Text
**** Scaling
#+begin_src emacs-lisp
;; default-text-scale.el: Allows decreasing/increasing text size globally
;; rather than on a per-buffer basis.
(use-package default-text-scale
  :bind (("C-M-=" . default-text-scale-increase)
         ("C-M--" . default-text-scale-decrease)))
#+end_src
**** Special
#+begin_src emacs-lisp
;; hl-mode.el: Provides highlighting for TODO, FIXME, etc.
(use-package hl-todo
  :hook (prog-mode . hl-todo-mode)
  :config
  (setq hl-todo-highlight-punctuation ":"
        hl-todo-keyword-faces
        `(("TODO"       warning bold)
          ("FIXME"      error bold)
          ("HACK"       font-lock-constant-face bold)
          ("REVIEW"     font-lock-keyword-face bold)
          ("NOTE"       success bold)
          ("DEPRECATED" font-lock-doc-face bold))))
#+end_src
**** Pretty
#+begin_src emacs-lisp
(use-package prettify-symbols-mode
  :straight nil
  :ensure nil
  :hook (prog-mode . prettify-symbols-mode)
  :init
  ;; Fontification is deactivated upon marker-enter.
  (setq prettify-symbols-unprettify-at-point 'right-edge))
#+end_src

Languages should then set the local variable =prettify-symbols-alist= on their own, e.g. see [[*Julia][Julia]].
**** Others
#+begin_src emacs-lisp
(use-package visual-fill-column
  :ensure t
  :custom
  (visual-fill-column-center-text t)
  :config
  (add-hook 'notmuch-show-hook '(lambda () (setq-local visual-fill-column-width 120)))
  (add-hook 'notmuch-show-hook 'visual-fill-column-mode))
#+end_src

*** File management & browsing
#+begin_src emacs-lisp
(use-package all-the-icons-dired
  :after (all-the-icons))

(use-package dired
  :ensure nil
  :straight nil
  :defer t
  :config
  (add-hook 'dired-mode-hook
            (lambda ()
              (interactive)
              ;; (dired-omit-mode 1) ;; TODO: Where is this from?
              ;; (dired-hide-details-mode 1)
              (when (display-graphic-p)
                ;; Activate the `all-the-icons-mode` if present.
                (all-the-icons-dired-mode 1))
              (hl-line-mode 1)))
  )
#+end_src
*** Navigation
**** Window navigation
#+begin_src emacs-lisp
;; ace-window.el: Allows you to jump between windows. Super-useful when you're using more than 2 windows.
;; HACK: Only load if we're using a GUI. For some reason `ace-window' making it so that
;; switching between windows inserts 'I's and 'O's.
(use-package ace-window
  :ensure nil
  :defer t
  ;; We might have multiple Emacs frames open, all using the same server.
  ;; In these cases it is usually undesired to have `ace-window' suggest
  ;; opening Emacs windows we can't even see. In addition, we usually then
  ;; end up with a huge number of candidates.
  ;; This limits the candidates that we can jump to to the current frame.
  :custom (aw-scope 'frame)
  ;; Feel free to change the binding.
  :bind ("M-[" . ace-window))

;; Only load `ace-window' upon frame-creation.
(add-hook after-make-frame-functions (lambda () (when (display-graphic-p) (require 'ace-window)))
#+end_src

**** Within-buffer navigation
#+begin_src emacs-lisp
;; avy.el: Allows you to jump to words by specifying the first character.
(use-package avy
  ;; Feel free to change the binding.
  :bind ("M-j" . avy-goto-word-or-subword-1))
#+end_src

** Utility
*** Snippets
#+begin_src emacs-lisp
;; yasnippet.el: Snippet engine.
(use-package yasnippet
  ;; Enable globally.
  :init (yas-global-mode)
  :config
  ;; Enable nested triggering of snippets.
  (setq yas-triggers-in-field t)
  ;; Ensures that the indentation is done after my choosing.
  (setq yas-indent-line 'fixed)
  )

;; yasnippet-snippets.el: A huge collection of useful snippets.
(use-package yasnippet-snippets)
#+end_src
*** PDF viewing
#+begin_src emacs-lisp
;; pdf-tools.el: Best. PDF viewer. Ever.
;; NOTE: might need to run `(pdf-tools-install)' to install dependencies.
(use-package pdf-tools
  :mode ("\\.vpdf\\.?$" . pdf-virtual-edit-mode)
  :config (pdf-tools-install))
#+end_src
** Project management
#+begin_src emacs-lisp
;; projectile.el: A _bunch_ of utility functionality for working with projects, e.g. rename everywhere
;; in a projet.
;; It'll automatically detect if something is a project using different heuristics, e.g.
;; if you have a `.git` file in a parent directory.
(use-package projectile
  :diminish projectile-mode ;; hide from mode-line since it'll be activated everywhere
  :bind-keymap ("C-c p" . projectile-command-map)
  :config
  (progn
    (setq projectile-completion-system 'default)
    (setq projectile-enable-caching t)
    (setq projectile-indexing-method 'alien)
    (add-to-list 'projectile-globally-ignored-files "node-modules")
    (projectile-global-mode)))
#+end_src

#+begin_src emacs-lisp 
;; helm-projectile.el: Improves interaction between `helm.el` and `projetile.el`.
(use-package helm-projectile)
(use-package helm-rg)
#+end_src

#+begin_src emacs-lisp
;; Use project name obtained from `projectile' as the default name for the tab.
(defun tor/name-tab-by-project-or-default ()
  "Return project name if in a project, or default tab-bar name if not.
The default tab-bar name uses the buffer name."
  (let ((project-name (projectile-project-name)))
    (if (string= "-" project-name)
        (tab-bar-tab-name-current)
      (projectile-project-name))))

(setq tab-bar-tab-name-function #'tor/name-tab-by-project-or-default)
#+end_src

#+begin_src emacs-lisp
(use-package treemacs)
(use-package treemacs-projectile)
(use-package treemacs-all-the-icons)
#+end_src
*** Git
#+begin_src emacs-lisp
;; magit.el: Objectively the best interface for working with Git-related stuff ever.
(use-package magit
  :config
  ;; Make `magit' look for the password in `~/.authinfo'.
  ;; Useful if you're working with, say, Overleaf where SSH is not an option for git.
  (add-hook 'magit-process-find-password-functions
            'magit-process-password-auth-source))
;; forge.el: Magit's interface to different repo hosts, e.g. Github, Gitlab.
(use-package forge)
#+end_src

#+begin_src emacs-lisp :tangle no
(use-package blamer
  :ensure t
  :defer 20
  :custom
  (blamer-idle-time 0.3)
  (blamer-min-offset 70)
  (blamer-commit-formatter "‚Ä¢ %s") ;; default symbol is too large
  :custom-face
  (blamer-face ((t :foreground "#586e75"
                   :background nil
                   :height 0.8 ;; make it slightly smaller than default font-size
                   :italic t)))
  :config
  (global-blamer-mode 1))
#+end_src

#+begin_src emacs-lisp 
(use-package git-link
  :ensure t
  :config (setq git-link-use-commit t))
#+end_src
*** Perspective
#+begin_src emacs-lisp 
;; For handling multiple workspaces in Emacs.
(use-package perspective
  :custom
  (persp-mode-prefix-key (kbd "C-x x"))
  :init
  (persp-mode))

(use-package persp-projectile)
#+end_src

** Editing
*** General
#+begin_src emacs-lisp
;; smartparens.el: Automatic insertion of pairs of characters.
(use-package smartparens
  :config (progn
            (require 'smartparens-config)
            (add-hook 'prog-mode-hook 'turn-on-smartparens-mode)
            (add-hook 'prog-mode-hook 'show-paren-mode t)))
#+end_src
*** Undo & redo
#+begin_src emacs-lisp
;; undo-tree.el: Tree-based undo-mechanism.
;; NOTE: To install, see https://github.com/zachcurry/emacs-anywhere.
(use-package undo-tree
  :diminish undo-tree-mode
  :init (global-undo-tree-mode))
#+end_src
** Auto completion
#+begin_src emacs-lisp
;; company.el: Autocomplete backend. Other packages implement frontends for this,
;; e.g. auto-completer for Python.
(use-package company
  :config
  (add-hook 'prog-mode-hook 'company-mode)
  )
#+end_src
** Terminal emulation
#+begin_src emacs-lisp
(use-package vterm
  :config (setq vterm-buffer-name-string "*vterm [%s]*"))
#+end_src

** Programming & Markup
*** Language Server Protocol
#+begin_src emacs-lisp
(use-package lsp-mode
  :init
  ;; set prefix for lsp-command-keymap (few alternatives - "C-l", "C-c l")
  (setq lsp-keymap-prefix "C-c l")
  :hook (;; replace XXX-mode with concrete major-mode(e.g. python-mode)
         (julia-mode . lsp)
         ;; if you want which-key integration
         (lsp-mode . lsp-enable-which-key-integration))
  :commands lsp)

(use-package lsp-ui :commands lsp-ui-mode)
(use-package lsp-treemacs :commands lsp-treemacs-errors-list)
#+end_src
*** Flycheck
#+begin_src emacs-lisp
(use-package flycheck
  :config
  ;; Make `flycheck' recognize the packages available in Emacs' `load-path'.
  ;; Otherwise we get complaints on every `(require ...)'.
  ;; https://github.com/flycheck/flycheck/issues/1559#issuecomment-478569550
  (setq flycheck-emacs-lisp-load-path 'inherit))
#+end_src
*** LaTeX
#+begin_src emacs-lisp
(use-package tex
  ;; NOTE: You might have to build Auctex manually. Checkout the `INSTALL`
  ;; file in the cloned repo.
  :straight (auctex
             :type git
             :host nil
             :repo "https://git.savannah.gnu.org/git/auctex.git")
  :custom
  (TeX-command-extra-options "-shell-escape")
  (TeX-source-correlate-start-server t)
  (TeX-macro-private nil "???")
  (TeX-parse-self t "Ensures that completion, etc. works properly.")
  (TeX-view-program-selection
   '(((output-dvi has-no-display-manager)
      "dvi2tty")
     ((output-dvi style-pstricks)
      "dvips and gv")
     (output-dvi "xdvi")
     (output-pdf "PDF Tools")
     (output-html "xdg-open"))
   "Specify the programs to use. In particular, use PDF tools for PDF viewing.")
  :config
  ;; Revert the document after compilation completes.
  (add-hook 'TeX-after-compilation-finished-functions #'TeX-revert-document-buffer)
  )

;; company-auctex.el: `company.el` frontend for `auctex.el`.
(use-package company-auctex
  :after (company)
  :hook (LaTeX-mode . company-mode)
  :init (company-auctex-init))

;; company-reftex.el: Completion of citations and labels within LaTeX commands, e.g. `\cite{}'.
(use-package company-reftex
  :after (company)
  :config (setq
           company-reftex-labels-regexp
           (rx "\\"
               ;; List taken from `reftex-ref-style-alist'
               (or "autoref"
                   "autopageref"
                   "Cpageref"
                   "cpageref"
                   "Cref"
                   "cref"
                   "eqref"
                   "Fref"
                   "fref"
                   "pageref"
                   "Ref"
                   "ref"
                   "vpageref"
                   "Vref"
                   "vref"
                   ;; custom stuff:
                   "propref"
                   "thmref"
                   "lemref"
                   "lemmaref"
                   "appref"
                   "assumptref"
                   "secref")
               "{"
               (group (* (not (any "}"))))
               (regexp "\\=")))
  (add-to-list 'company-backends 'company-reftex-labels)
  (add-to-list 'company-backends 'company-reftex-citations))
#+end_src
*** Markdown
#+begin_src emacs-lisp
;; markdown-mode.el: Standard mode for markdown.
(use-package markdown-mode
  :hook
  (
   ;; `visual-line-mode` adds word-wrap, etc.
   (markdown-mode . visual-line-mode)
   ;; Makes it so that we get automatic closing of **, etc.
   (markdown-mode . turn-on-smartparens-mode)
   )
  )
#+end_src
*** Polymode
#+begin_src emacs-lisp
;; polymode: Allows you to use multiple modes within a single buffer, e.g.
;; use `julia-mode` for highlighting, etc. in a code-block within a markdown file.
(use-package polymode)

;; poly-markdown.el: Implementation of `polymode` for markdown, allowing other modes
;; to be used within buffers with `markdown-mode` enabled.
(use-package poly-markdown
  :mode ("\\.[jJ]md" . poly-markdown-mode) ;; Also enable for .jmd files.
  :bind (:map poly-markdown-mode-map
              ("C-c '" . markdown-edit-code-block)))

;; edit-indirect.el: Allows one to parts/subsections of buffers in a separate editable buffer,
;; whose changes are reflected in the main document. This is used by `poly-markdown` to allow
;; opening code-blocks in a separate editable buffer (see the `markdown-edit-code-block` from
;; the above `poly-markdown` block).
(use-package edit-indirect
  :config (progn
            (define-key edit-indirect-mode-map (kbd "C-c C-c") nil)))
#+end_src
*** Julia
#+begin_src emacs-lisp
;; Julia
(defvar prettify-symbols-alist--julia
  '(
    ("lambda" . ?Œª)
    ("->" . ?‚Ü¶)
    ("=>" . ?‚üπ)
    ))

(defun my/set-julia-prettify-symbols-alist ()
  (setq prettify-symbols-alist prettify-symbols-alist--julia)
  ;; HACK: It seems like we need to "re-enable" the mode to load the updated `prettify-symbols-alist'.
  (prettify-symbols-mode 1))

(use-package julia-mode
  :config
  (add-hook 'julia-mode-hook 'my/set-julia-prettify-symbols-alist)
  )
#+end_src

#+begin_src emacs-lisp
;; The `lsp' setup for Julia
;; You might need to dev both `LanguageServer.jl' and `StaticLint.jl'
;; for everything to work (at least I had to on 02/03/2021).
(use-package lsp-julia
  ;; :pin melpa
  :config (progn
            ;; (setq lsp-julia-package-dir nil)
            (setq lsp-julia-default-environment "~/.julia/environments/v1.8")))
#+end_src
*** Python
#+begin_src emacs-lisp
;; Python
(use-package python
  :hook
  (
   ;; Make it so that `elpy-mode` is also enabled whenever `python-mode` is.
   (python-mode . elpy-mode)
   )
  )

(use-package elpy
  :defer t
  ;; `advice-add` effecftively allows you insert code before/after the execution of
  ;; some other functions. In this case we insert `(elpy-enable)` "before" `python-mode`,
  ;; i.e. whenever `python-mode` is called, `elpy-enable` will be called just before it.
  :init (advice-add 'python-mode :before 'elpy-enable))
#+end_src
*** Lisp
**** Emacs-lisp
#+begin_src emacs-lisp
(use-package rainbow-delimiters
  :hook ((emacs-lisp-mode . rainbow-delimiters-mode)
         (ielm-mode . rainbow-delimiters-mode)
         (lisp-interaction-mode . rainbow-delimiters-mode)
         (list-mode . rainbow-delimiters-mode))
  ;; :config
  ;; ;; Custom faces.
  ;; (set-face-foreground 'rainbow-delimiters-depth-1-face "#c66")  ; red
  ;; (set-face-foreground 'rainbow-delimiters-depth-2-face "#6c6")  ; green
  ;; (set-face-foreground 'rainbow-delimiters-depth-3-face "#69f")  ; blue
  ;; (set-face-foreground 'rainbow-delimiters-depth-4-face "#cc6")  ; yellow
  ;; (set-face-foreground 'rainbow-delimiters-depth-5-face "#6cc")  ; cyan
  ;; (set-face-foreground 'rainbow-delimiters-depth-6-face "#c6c")  ; magenta
  ;; (set-face-foreground 'rainbow-delimiters-depth-7-face "#ccc")  ; light gray
  ;; (set-face-foreground 'rainbow-delimiters-depth-8-face "#999")  ; medium gray
  ;; (set-face-foreground 'rainbow-delimiters-depth-9-face "#666")  ; dark gray
  )
#+end_src
*** Jupyter
#+begin_src emacs-lisp
;; Jupyter
;; This is awesome _but_ requires an Emacs version built with dynamic modules.
;; See https://github.com/nnicandro/emacs-zmq for more information on this.
;; But if this has been done, then you cna uncomment the line below.
(use-package jupyter
  :bind (:map jupyter-repl-interaction-mode-map
              ("C-<return>" . jupyter-eval-line-or-region)
              ("C-M-<return>" . jupyter-eval-defun)
              )
  :config
  (setq org-babel-default-header-args:jupyter-julia '((:async . "yes")
                                                      (:session . "jl")
                                                      (:kernel . "julia-1.8")))
  (setq org-babel-default-header-args:jupyter-python '((:async . "yes")
                                                       (:session . "py")
                                                       (:kernel . "python3"))))
#+end_src
*** R
#+begin_src emacs-lisp 
(use-package ess)
#+end_src

** Org
A couple of notes before we start going through the config for all org-related:
1. =org= is a dependency of a bunch of packages, e.g. =org-ref=, /and/ we often want to have a custom recipe for =org=, e.g. =:straight (org :type buil-in)= to ensure that we're using the built-in version of =org=. In this case, to ensure that our custom recipe is respected, we need to load =org= /before/ any of its dependencies (otherwise we'll end up using the default recipe of =org= in the installation of the dependant).
   - https://github.com/raxod502/straight.el#recipe-lookup for more about this.

*** Tor's reading list
#+begin_src emacs-lisp 
;; Tor's reading list and stuff
(defun tor/element--sort-elements-by-raw-value (el1 el2)
  "Compare :raw-value of EL1 and EL2, returning true if EL2 > EL1."
  (string-greaterp (org-element-property :raw-value el2)
		   (org-element-property :raw-value el1)))

(defun tor/element--get-begin (el)
  "Get beginning of EL."
  (org-element-property :begin el))

(defun tor/element--get-end (el)
  "Get end of EL."
  (org-element-property :end el))

(defun tor/reading-list-sort (&optional level)
  "Sort reading list at LEVEL."
  (interactive)
  (let* ((i 0)
	 (headline-level (or level 1))
	 (parsed (org-element-parse-buffer))
	 (headlines (-filter (lambda (el) (= (org-element-property :level el) headline-level)) 
			    (org-element-map parsed 'headline 'identity)))
	 (start (-min (-map 'tor/element--get-begin headlines)))
	 (end (-max (-map 'tor/element--get-end headlines))))
    (delete-region start end)
    (goto-char start)
    (insert (string-join
	     ;; TODO: update indices
	     (-map
	      (lambda (el)
		(progn
		  (setq i (+ i 1))
		  (replace-regexp-in-string "* TODO [0-9]+\\."
					    (format "* TODO %03d." i)
					     el)))
	      (-map 'org-element-interpret-data
			 (sort headlines 'tor/element--sort-elements-by-raw-value)))
	     ""))))

(defun tor/reading-list--get-next-idx (&optional level category)
  "Get index for reading list at LEVEL and ."
  (let* ((headline-level (or level 1))
	 (parsed (org-element-parse-buffer))
	 (headlines (-filter (lambda (el) (and (= (org-element-property :level el) headline-level)
					  ;; FIXME: BROKEN. Grab this from the property-drawer
					  (if category
					      (org-element-property :category el)
					    t)))
			     (org-element-map parsed 'headline 'identity))))
    (+ 1 (-max
	  (or (-filter
	       (lambda (x) (not (= x 0)))
	       (-map (lambda (el)
		       (string-to-number
			(car (split-string
			      (org-element-property :raw-value el) "\\."))))
		     headlines))
	      '(0))))))

(defun tor/reading-list-next-idx ()
  (save-excursion
    (with-current-buffer (find-file-noselect "~/Dropbox/org/reading.org")
      (format "%03d" (tor/reading-list--get-next-idx)))))
#+end_src

*** Agenda utilities
#+begin_src emacs-lisp 
(defun my/org-skip-subtree-if-priority (priority)
  "Skip an agenda subtree if it has a priority of PRIORITY.

PRIORITY may be one of the characters ?A, ?B, or ?C."
  (let ((subtree-end (save-excursion (org-end-of-subtree t)))
        (pri-value (* 1000 (- org-lowest-priority priority)))
        (pri-current (org-get-priority (thing-at-point 'line t))))
    (if (= pri-value pri-current)
        subtree-end
      nil)))

(defun my/pop-to-org-agenda ()
  "Visit the org agenda in the current window."
  (interactive)
  (let ((org-agenda-window-setup 'current-window))
    (org-agenda nil "c")))
#+end_src
*** Org
#+begin_src emacs-lisp
(defvar prettify-symbols-alist--org
  '(
    ("#+name:" . ?‚úé)
    ("#+begin_src" . ?‚Ü™)
    ("#+end_src" . ?‚ñ°)
    ("#+begin_definition" . ?ùíü)
    ("#+end_definition" . ?‚ñ°)
    ("#+begin_theorem" . ?ùíØ)
    ("#+end_theorem" . ?‚ñ°)
    ("#+begin_proof" . ?ùí´)
    ("#+end_proof" . ?‚ñ†)
    ))

(defun my/prettify-symbols-alist-set--org ()
  (setq prettify-symbols-alist prettify-symbols-alist--org)
  ;; HACK: It seems like we need to "re-enable" the mode to load the updated `prettify-symbols-alist'.
  (prettify-symbols-mode 1))


(use-package org
  ;; Ensures that we're using the version of `org` which comes with Emacs.
  :straight (org :type built-in)
  :hook (org-mode . my/prettify-symbols-alist-set--org)
  :config
  ;; customization for latex-preview in org-mode
  (setq org-format-latex-options '(:foreground default
                                               :background default
                                               :scale 1.5
                                               :html-foreground "steelblue"
                                               :html-background "Transparent"
                                               :html-scale 1.0
                                               :matchers ("begin" "$1" "$" "$$" "\\(" "\\[")))

  ;; During LaTeX export, try to preserve the labels defined by the user.
  (setq org-latex-prefer-user-labels t)
  ;; Hide emphasis markup.
  (setq org-hide-emphasis-markers nil)
  ;; Use bullets for lists.
  (font-lock-add-keywords 'org-mode
                          '(("^ *\\([-]\\) "
                             (0 (prog1 () (compose-region (match-beginning 1) (match-end 1) "‚Ä¢"))))))
  ;; Don't query us every time we trying to evaluate code in buffers.
  (setq org-confirm-babel-evaluate nil)
  ;; Don't indent text in a section to align with section-level.
  (setq org-adapt-indentation nil)
  ;; Don't indent body of code-blocks at all.
  (setq org-edit-src-content-indentation 0)
  ;; Allow setting variables in setup-files.
  (setq org-export-allow-bind-keywords t)
  ;; Where to store the generated images from `org-latex-preivew'. This '/' at the end is VERY important.
  (setq org-preview-latex-image-directory "~/.ltximg/")
  ;; Make it so that the src block is opened in the current window when we open to edit.
  (setq org-src-window-setup 'current-window)
  ;; Necessary for header-arguments in src-blocks to take effect during export.
  (setq org-export-use-babel t)
  ;; Disable execution of code-blocks on export by default.
  (add-to-list 'org-babel-default-header-args '(:eval . "never-export"))
  ;; Use `minted' for latex exports.
  (setq org-latex-listings 'minted)
  ;; Allow customization of image preview width.
  (setq org-image-actual-width nil)

  ;; Open exported PDFs in emacs using `pdf-tools'.
  (add-to-list 'org-file-apps '("\\.pdf\\'" . emacs))

  ;; Make `org-goto' nice to work with.
  ;; Source: https://emacs.stackexchange.com/a/32625
  ;; Complete on outlines/headings.
  ;; This uses `completing-read' behind the scenes, hence if you have something like
  ;; `helm' or `ivy' activated, this will be used for the completion.
  (setq org-goto-interface 'outline-path-completion)
  ;; Don't try to complete headings in steps.
  (setq org-outline-path-complete-in-steps nil)

  ;; Org-agenda / Org-capture related
  (setq org-agenda-files '("~/Dropbox/org/gtd.org"
                           "~/Dropbox/org/school.org"
                           "~/Dropbox/org/reading.org"
                           "~/Dropbox/org/implement.org"))
  (setq org-default-notes-file "~/Dropbox/org/gtd.org")
  (setq org-refile-targets '(("~/Dropbox/org/gtd.org" :maxlevel . 2)))

  (setq org-capture-templates
        '(("t"        ;; shortcut
           "Todo"     ;; title
           entry      ;; type of template
           (file+headline "~/Dropbox/org/gtd.org" "Tasks")  ;; what and where to add
           "* TODO %^{Brief Description} %^g\nEntered on %U\n%?\n%i\n%a"  ;; template
           :empty-lines 1 ;; property
           )

          ("e"        ;; shortcut
           "Reply to email"     ;; title
           entry      ;; type of template
           (file+headline "~/Dropbox/org/gtd.org" "Mail correspondance")  ;; what and where to add
           "* TODO %:from %:subject\nSCHEDULED: %t\n:PROPERTIES:\n:END:\n\n%a\n\n%?"
           :empty-lines 1 ;; property
           )

          ("j" "Journal" entry (file+datetree "~/Dropbox/org/journal.org")
           "* %^{Description}\nEntered on %U\n%a\n%?" :empty-lines 1)

          ("i" "Idea" item (file "~/Dropbox/org/ideas.org"))

          ("s" "School" entry
           (file "~/Dropbox/org/school.org")
           "* TODO %^{Brief Description} %^{COURSE}p %^g\n%?" :empty-lines 1)

          ("r" "Reading" entry (file "~/Dropbox/org/reading.org")
           "* TODO %(tor/reading-list-next-idx). %?\nEntered on %U\n%a\n%i")

          ("R" "Research" entry (file "~/org-blog/notes/research.org")
           "* %^{Title} %^g\n:PROPERTIES:\n:DATE: %U\n:SOURCE: %a\n:END:\n%i\n%?")

          ("I" "Implement" entry (file "~/Dropbox/org/implement.org")
           "* TODO %(tor/impl-list-next-idx). %?\nEntered on %U\n%a\n%i")

          ;; NOTE: the `ANKI_DECK' property will use auto-completion from `anki-editor.el'
          ;; and thanks to the use of `anki-editor-mode' in `~/Dropbox/org/anki.org'
          ;; we also get autocomplete for the tags.
          ("a" "Anki basic"
           entry
           (file+headline org-my-anki-file "Dispatch Shelf")
           "* %U   %^g\n:PROPERTIES:\n:ANKI_NOTE_TYPE: Basic\n:END:%^{ANKI_DECK}p\n** Front\n%?\n** Back\n%x\n")

          ("A" "Anki cloze"
           entry
           (file+headline org-my-anki-file "Dispatch Shelf")
           "* %U   %^g\n:PROPERTIES:\n:ANKI_NOTE_TYPE: Cloze\n:END:%^{ANKI_DECK}p\n** Text\n%x\n** Extra\n")

          ("c"
           "Code"
           entry
           (file+headline "~/Dropbox/org/gtd.org" "Code")
           "* TODO %^{TITLE} %^G\n:PROPERTIES:\n:Created: %U\n:Source: %a\n:END:\n%i%?"
           :prepend t	 ; properties
           :empty-lines 1	 ; properties
           :created t	 ; properties
           :kill-buffer t) ; properties
          ))

  (setq org-agenda-custom-commands
	    '(("r" alltodo "" ((org-agenda-files '("~/Dropbox/org/reading.org"))))
          ("c" "My agenda view"
           ((tags "PRIORITY=\"A\""
                  ((org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))
                   (org-agenda-overriding-header "High-priority unfinished tasks:")))
            (agenda "" ((org-agenda-span 1)
                        (org-habit-graph-column 60)))
            ;; TODO: Do we need a weekly view too?
            ;; (agenda "")
            (alltodo ""
                     ((org-agenda-files '("~/Dropbox/org/reading.org"))
                      (org-agenda-overriding-header "Readings (top 5):")
                      (org-agenda-max-entries 5)))
            (alltodo ""
                     ((org-agenda-skip-function
                       '(or (my/org-skip-subtree-if-priority ?A)
                            (org-agenda-skip-if nil '(scheduled deadline))))
                      (org-agenda-files '("~/Dropbox/org/gtd.org")))))
           ((org-agenda-compact-blocks nil)))))

  ;; Hooks.
  ;; If `flycheck` is installed, disable `flycheck` in src-blocks.
  ;; NOTE: This is maybe a bit "harsh". Could potentially just disable certain
  ;; features of `flycheck`.
  (when (my/straight-installed-p 'flycheck)
    (require 'flycheck)
    (defun disable-flycheck-in-org-src-block ()
      (flycheck-mode -1))
    (add-hook 'org-src-mode-hook 'disable-flycheck-in-org-src-block))

  ;; Use `visual-line-mode' as it gives word-wrapping, etc.
  (add-hook 'org-mode-hook 'visual-line-mode)

  ;; https://emacs.stackexchange.com/a/18146
  ;; I want this bindings for references, etc. + don't add files to agenda
  ;; often enough to warrant having a binding for it.
  (require 'bind-key)
  (unbind-key "C-c [" org-mode-map)
  (unbind-key "C-c ]" org-mode-map)
  (unbind-key "C-c ," org-mode-map)
  (bind-key "C-c ," 'org-time-stamp-inactive org-mode-map)

  ;; Make `org-capture' globally available.
  (global-set-key (kbd "C-c c") 'org-capture)

  ;;;; Org-Babel ;;;;
  ;; HACK: Need to load this here to ensure that we don't end up installing `org' (which is likely
  ;; to be a dependency of `ob-*' babel) using the wrong recipe.
  (use-package ob-julia
    :config (setq org-babel-julia-command "julia"))

  ;; Specify which programming languages to support in code-blocks.
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp t)
     (shell . t)
     (C . t)
     (latex . t)
     (python . t)
     (jupyter . t)
     (R . t)
     ;; (julia-vterm . t)
     (julia . t)
     ))

  (require 'ob-jupyter)
  (org-babel-jupyter-override-src-block "julia")
  (org-babel-jupyter-override-src-block "python")
  :custom
  (org-format-latex-header
   "\\documentclass{article}
\\usepackage[usenames]{color}
[PACKAGES]
[DEFAULT-PACKAGES]
\\pagestyle{empty}             % do not remove
% The settings below are copied from fullpage.sty
\\setlength{\\textwidth}{\\paperwidth}
\\addtolength{\\textwidth}{-3cm}
\\setlength{\\oddsidemargin}{1.5cm}
\\addtolength{\\oddsidemargin}{-2.54cm}
\\setlength{\\evensidemargin}{\\oddsidemargin}
\\setlength{\\textheight}{\\paperheight}
\\addtolength{\\textheight}{-\\headheight}
\\addtolength{\\textheight}{-\\headsep}
\\addtolength{\\textheight}{-\\footskip}
\\addtolength{\\textheight}{-3cm}
\\setlength{\\topmargin}{1.5cm}
\\addtolength{\\topmargin}{-2.54cm}")

  (org-latex-default-packages-alist
   '(("AUTO" "inputenc" t
      ("pdflatex"))
     ("T1" "fontenc" t
      ("pdflatex"))
     ("" "graphicx" t nil)
     ("" "grffile" t nil)
     ("" "longtable" nil nil)
     ("" "wrapfig" nil nil)
     ("" "rotating" nil nil)
     ("normalem" "ulem" t nil)
     ("" "amsmath" t nil)
     ("" "textcomp" t nil)
     ("" "amssymb" t nil)
     ("" "capt-of" nil nil)
     ;; ("" "hyperref" nil nil) ;; NOTE: this is usually included in the `header.tex'
     ("" "mathpazo" t nil)
     ("" "eulervm" t nil)))

  (org-preview-latex-process-alist
   '((dvipng :programs
             ("latex" "dvipng")
             :description "dvi > png" :message "you need to install the programs: latex and dvipng." :image-input-type "dvi" :image-output-type "png" :image-size-adjust
             (1.0 . 1.0)
             :latex-compiler
             ("latex -interaction nonstopmode -output-directory %o %f")
             :image-converter
             ("dvipng -D %D -T tight -bg 'Transparent' -o %O %f"))
     (dvisvgm :programs
              ("latex" "dvisvgm")
              :description "dvi > svg" :message "you need to install the programs: latex and dvisvgm." :image-input-type "dvi" :image-output-type "svg" :image-size-adjust
              (1.7 . 1.5)
              :latex-compiler
              ("latex -interaction nonstopmode -output-directory %o %f")
              :image-converter
              ("dvisvgm %f -n -b min -c %S -o %O"))
     (imagemagick :programs
                  ("latex" "convert")
                  :description "pdf > png" :message "you need to install the programs: latex and imagemagick." :image-input-type "pdf" :image-output-type "png" :image-size-adjust
                  (1.0 . 1.0)
                  :latex-compiler
                  ("pdflatex -interaction nonstopmode -output-directory %o %f")
                  :image-converter
                  ("convert -density %D -trim -antialias %f -quality 100 %O"))))

  ;; Add `-shell-escape' to the PDF process so we can use `minted'.
  (org-latex-pdf-process '("latexmk -shell-escape -bibtex -pdf %f"))
  )

(use-package org-bullets
  :after org
  :config
  (add-hook 'org-mode-hook (lambda () (org-bullets-mode 1))))

(use-package org-pdftools
  :hook (org-mode . org-pdftools-setup-link))
#+end_src

*** Org Export
**** Jupyter notebook
#+begin_src emacs-lisp
(use-package ox-ipynb
  :straight (:type git :host github :repo "jkitchen/ox-ipynb")
  :init
  ;; It doesn't respect the `(org-babel-jupyter-override-src-block "python")' statements
  ;; and so it won't recognize `python' blocks as `jupyter-python', and thus not export properly.
  (setq ox-ipynb-kernelspecs '((R . (kernelspec . ((display_name . "R")
                                                   (language . "R")
                                                   (name . "ir"))))
                               (julia . (kernelspec . ((display_name . "Julia 1.6.2")
                                                       (language . "julia")
                                                       (name . "julia-1.6"))))
                               (jupyter-python . (kernelspec . ((display_name . "Python 3")
                                                                (language . "python")
                                                                (name . "python3"))))
                               (python . (kernelspec . ((display_name . "Python 3")
                                                        (language . "python")
                                                        (name . "python3"))))))


  (setq ox-ipynb-language-infos
        '((jupyter-python . (language_info . ((codemirror_mode . ((name . ipython)
                                                                  (version . 3)))
                                              (file_extension . ".py")
                                              (mimetype . "text/x-python")
                                              (name . "python")
                                              (nbconvert_exporter . "python")
                                              (pygments_lexer . "ipython3")
                                              (version . "3.8.10"))))
          (python . (language_info . ((codemirror_mode . ((name . ipython)
                                                          (version . 3)))
                                      (file_extension . ".py")
                                      (mimetype . "text/x-python")
                                      (name . "python")
                                      (nbconvert_exporter . "python")
                                      (pygments_lexer . "ipython3")
                                      (version . "3.8.10"))))

          (julia . (language_info . ((codemirror_mode . "julia")
                                     (file_extension . ".jl")
                                     (mimetype . "text/x-julia")
                                     (name . "julia")
                                     (pygments_lexer . "julia")
                                     (version . "1.6.2"))))

          (R . (language_info . ((codemirror_mode . "r")
                                 (file_extension . ".r")
                                 (mimetype . "text/x-r-source")
                                 (name . "R")
                                 (pygments_lexer . "r")
                                 (version . "3.3.2")))))))
#+end_src
**** Org-reveal
#+begin_src emacs-lisp 
(use-package ox-reveal
  ;; NOTE: Necessary because otherwise we end up trying to load `org-reveal'
  ;; which is actually not provided (despite the name of the project).
  :straight (ox-reveal :host github :repo "yjwen/org-reveal"))
#+end_src

#+begin_src emacs-lisp 
;; HACK: This piece of code let's me 
(setq reveal--revealjs-version "4.1.0")
(setq reveal--mathjax-version "2.7.5")
(setq reveal--revealjs-cdn-base "https://cdnjs.cloudflare.com/ajax/libs/reveal.js/")
(setq reveal--mathjax-cdn-base "https://cdnjs.cloudflare.com/ajax/libs/mathjax/") 

(defun reveal--revealjs-local-basename ()
  (concat "reveal.js-" reveal--revealjs-version))

(defun reveal--mathjax-local-basename ()
  (concat "MathJax-" reveal--mathjax-version))

(defun reveal--revealjs-cdn-basename ()
  reveal--revealjs-version)

(defun reveal--mathjax-cdn-basename ()
  reveal--mathjax-version)

(defun reveal--revealjs-cdn ()
  (concat reveal--revealjs-cdn-base (reveal--revealjs-cdn-basename)))

(defun reveal--mathjax-cdn ()
  (concat reveal--mathjax-cdn-base (reveal--mathjax-cdn-basename)))

(defun reveal--revealjs-local (asset-path)
  (f-join asset-path (reveal--revealjs-local-basename)))

(defun reveal--mathjax-local (asset-path)
  (f-join asset-path (reveal--mathjax-local-basename)))

(defun reveal--replace-local-with-cdn (asset-path)
  (let* ((revealjs-local-path (reveal--revealjs-local asset-path))
         (mathjax-local-path (reveal--mathjax-local asset-path))
         (regexp-optimized (regexp-opt
                            (list
                             revealjs-local-path
                             (concat "file://" revealjs-local-path)
                             (f-join revealjs-local-path "dist")
                             (concat "file://" (f-join revealjs-local-path "dist"))
                             mathjax-local-path
                             (concat "file://" mathjax-local-path)
                             ))))
   (save-excursion
     ;; Go the beginning of the buffer.
     (goto-char (point-min))
     ;; Find the matches.
     (save-match-data
       (while (re-search-forward regexp-optimized nil t)
         (cond
          ((save-match-data
             (string-match (reveal--revealjs-local asset-path) (match-string 0)))
           (replace-match (reveal--revealjs-cdn)))
          ((save-match-data
             (string-match (reveal--mathjax-local asset-path) (match-string 0)))
           (replace-match (reveal--mathjax-cdn)))
          (_ (error "couldn't find the a match")))
         )))))

(defun reveal--default-asset-path ()
  (f-join (buffer-file-name) ".." "assets"))

(defun reveal-replace-local-with-cdn (asset-path)
  (interactive (list
                (read-string (format "directory (%s): " (reveal--default-asset-path))
                             nil nil (reveal--default-asset-path))))
  (reveal--replace-local-with-cdn asset-path))
#+end_src
*** Org-roam
#+begin_src emacs-lisp
(use-package org-roam
  :straight (:type git :host github :repo "org-roam/org-roam-v1")
  ;; :hook
  ;; (after-init . org-roam-mode)
  :custom
  (org-roam-directory (file-truename "~/org-roam/"))
  (org-roam-completion-everywhere t)
  (org-roam-include-type-in-ref-path-completions t)
  :bind (:map org-roam-mode-map
         (("C-c n l" . org-roam)
          ("C-c n f" . org-roam-find-file)
          ("C-c n g" . org-roam-graph))
         :map org-mode-map
         (("C-c n i" . org-roam-insert))
         (("C-c n I" . org-roam-insert-immediate)))
  )
#+end_src

*** Org-ref
#+begin_src emacs-lisp
;; helm-bibtex.el: Provides completion with `helm` for bibliographies.
(use-package helm-bibtex
  :bind ("C-c ]" . helm-bibtex)
  :config
  (setq bibtex-completion-library-path '("~/Dropbox/bibliography/pdfs/"))
  (setq bibtex-completion-bibliography '("~/Dropbox/bibliography/references.bib"))
  (setq bibtex-completion-additional-search-fields '(keywords))
  (setq bibtex-completion-pdf-field "file")

  ;; Same as old `org-ref'
  (setq bibtex-completion-display-formats 
        '((t . "${author:36} ${title:*} ${year:4} ${=has-pdf=:1}${=has-note=:1} ${=type=:7} ${keywords:40}")))

  ;; Use `org-ref-insert-cite-keys' for citation formatting when in `org-mode'.
  (setq bibtex-completion-format-citation-functions
        ;; TODO: Actually, functions used here are expected to _return_ the formatted string, _not_ insert
        ;; it directly into the buffer (which is what `org-ref-insert-cite-keys' does).
        '((org-mode . org-ref-insert-cite-keys)
          (latex-mode . bibtex-completion-format-citation-cite)
          (markdown-mode . bibtex-completion-format-citation-pandoc-citeproc)
          (python-mode . bibtex-completion-format-citation-sphinxcontrib-bibtex)
          (rst-mode . bibtex-completion-format-citation-sphinxcontrib-bibtex)
          (default . bibtex-completion-format-citation-default)))
  )

;; org-ref.el: Provides citation management and handling for Org-mode.
(use-package org-ref
  :config
  ;; Use `helm-bibtex' for completion etc.
  (require 'org-ref-helm)
  (setq org-ref-insert-link-function 'org-ref-insert-link-hydra/body
        org-ref-insert-cite-function 'org-ref-cite-insert-helm
        org-ref-insert-label-function 'org-ref-insert-label-link
        org-ref-insert-ref-function 'org-ref-insert-ref-link
        org-ref-cite-onclick-function (lambda (_) (org-ref-citation-hydra/body))))
#+end_src

*** helm-org-named
#+begin_src emacs-lisp
(use-package helm-org-named
  :straight (:type git :host github :repo "torfjelde/helm-org-named")
  :bind ("C-c [" . helm-org-named)
  :config
  (setq helm-org-named-directories '("/home/tor/org-blog/notes")))
#+end_src

*** Org-pomodoro
#+begin_src emacs-lisp 
(use-package org-pomodoro
  :ensure-system-package mplayer
  :config
  ;; Add notification.
  ;; NOTE: This might only work on linux.
  (setq alert-user-configuration (quote ((((:category . "org-pomodoro")) libnotify nil))))
  ;; Keep the time entered even if we killed the timer midway.
  (setq org-pomodoro-keep-killed-pomodoro-time t)
  ;; Use 45min sessions instead.
  (setq org-pomodoro-length 45)
  ;; Force us to enter break manually, thus we're just making `org-pomodoro` a "notifier" that
  ;; we've spent so and so much time on a particular task, rather than religiously following "The Pomodoro Way".
  (setq org-pomodoro-manual-break t)
  ;; ;; Disable sound.
  ;; (setq org-pomodoro-play-sounds nil)

  ;; Use `mplayer' since this allows us specify the volume.
  (setq org-pomodoro-audio-player "mplayer")
  (setq org-pomodoro-finished-sound-args "-volume 50")
  (setq org-pomodoro-long-break-sound-args "-volume 50")
  (setq org-pomodoro-short-break-sound-args "-volume 50")

  ;; Play a sound when we start. It's useful feedback.
  (setq org-pomodoro-start-sound-p t)
  (setq org-pomodoro-start-sound-args "-volume 50")

  ;; Play a sound when we run into overtime too.
  (setq org-pomodoro-overtime-sound-p t)
  (setq org-pomodoro-overtime-sound-args "-volume")
  )
#+end_src

*** Org-ql
A query language for Org-files. In particular, the commands =org-ql-view= and =org-sq-search= are useful.
#+begin_src emacs-lisp 
(use-package org-ql)
#+end_src

*** Org-noter
#+begin_src emacs-lisp 
(use-package org-noter
  :config
  ;; Don't hide the other sections when we scroll to a new page.
  (setq org-noter-hide-other nil)

  (setq org-noter-doc-property-in-notes t)

  (setq org-noter-notes-search-path '("~/org-blog/papers/"))
  (setq org-noter-default-notes-file-names '("notes.org"))
  ;; (require 'org-noter-pdftools)
  )

(use-package org-noter-pdftools
  :after org-noter
  :config
  ;; Add a function to ensure precise note is inserted
  (defun org-noter-pdftools-insert-precise-note (&optional toggle-no-questions)
    (interactive "P")
    (org-noter--with-valid-session
     (let ((org-noter-insert-note-no-questions (if toggle-no-questions
                                                   (not org-noter-insert-note-no-questions)
                                                 org-noter-insert-note-no-questions))
           (org-pdftools-use-isearch-link t)
           (org-pdftools-use-freestyle-annot t))
       (org-noter-insert-note (org-noter--get-precise-info)))))

;;   ;; fix https://github.com/weirdNox/org-noter/pull/93/commits/f8349ae7575e599f375de1be6be2d0d5de4e6cbf
;;   (defun org-noter-set-start-location (&optional arg)
;;     "When opening a session with this document, go to the current location.
;; With a prefix ARG, remove start location."
;;     (interactive "P")
;;     (org-noter--with-valid-session
;;      (let ((inhibit-read-only t)
;;            (ast (org-noter--parse-root))
;;            (location (org-noter--doc-approx-location (when (called-interactively-p 'any) 'interactive))))
;;        (with-current-buffer (org-noter--session-notes-buffer session)
;;          (org-with-wide-buffer
;;           (goto-char (org-element-property :begin ast))
;;           (if arg
;;               (org-entry-delete nil org-noter-property-note-location)
;;             (org-entry-put nil org-noter-property-note-location
;;                            (org-noter--pretty-print-location location))))))))

  (with-eval-after-load 'pdf-annot
    (add-hook 'pdf-annot-activate-handler-functions #'org-noter-pdftools-jump-to-note)))
#+end_src

*** Org-download
#+begin_src emacs-lisp 
(use-package org-download
  :custom
  (org-download-heading-lvl nil "Don't use the sub-headings for the folder names")
  (org-download-image-org-width 600)
  (org-download-display-inline-images nil "Don't display inline images after download")
  :config (progn
            ;; HACK: overload this method so we fall back to using "./.filename/assets/" for the downloaded stuff
            (defun org-download--dir-1 ()
              (or org-download-image-dir (concat (file-name-as-directory ".") "." (file-name-base) "/attachments")))))
#+end_src

*** Org-id
#+begin_src emacs-lisp
;; Generate ID for headline if none exist.
(require 'org-id)
(defun org-id-new (&optional prefix)
  "Create a new globally unique ID.
An ID consists of two parts separated by a colon:
- a prefix
- a unique part that will be created according to `org-id-method'.
PREFIX can specify the prefix, the default is given by the variable
`org-id-prefix'.  However, if PREFIX is the symbol `none', don't use any
prefix even if `org-id-prefix' specifies one.
So a typical ID could look like \"Org-4nd91V40HI\"."
  (let* ((prefix (if (eq prefix 'none)
                     ""
                   (concat (or prefix org-id-prefix) "-")))
         unique)
    (if (equal prefix "-") (setq prefix ""))
    (cond
     ((memq org-id-method '(uuidgen uuid))
      (setq unique (org-trim (shell-command-to-string org-id-uuid-program)))
      (unless (org-uuidgen-p unique)
        (setq unique (org-id-uuid))))
     ((eq org-id-method 'org)
      (let* ((etime (org-reverse-string (org-id-time-to-b36)))
             (postfix (if org-id-include-domain
                          (progn
                            (require 'message)
                            (concat "@" (message-make-fqdn))))))
        (setq unique (concat etime postfix))))
     (t (error "Invalid `org-id-method'")))
    (concat prefix unique)))


(defun my/generate-sanitized-alnum-dash-string(str)
  "Returns a string which contains only a-zA-Z0-9 with single dashes
 replacing all other characters in-between them.
 Some parts were copied and adapted from org-hugo-slug
 from https://github.com/kaushalmodi/ox-hugo (GPLv3)."
  (let* (;; Remove "<FOO>..</FOO>" HTML tags if present.
         (str (replace-regexp-in-string "<\\(?1:[a-z]+\\)[^>]*>.*</\\1>" "" str))
         ;; Remove URLs if present in the string.  The ")" in the
         ;; below regexp is the closing parenthesis of a Markdown
         ;; link: [Desc](Link).
         (str (replace-regexp-in-string (concat "\\](" ffap-url-regexp "[^)]+)") "]" str))
         ;; Replace "&" with " and ", "." with " dot ", "+" with
         ;; " plus ".
         (str (replace-regexp-in-string
               "&" " and "
               (replace-regexp-in-string
                "\\." " dot "
                (replace-regexp-in-string
                 "\\+" " plus " str))))
         ;; Replace German Umlauts with 7-bit ASCII.
         (str (replace-regexp-in-string "[√Ñ]" "Ae" str t))
         (str (replace-regexp-in-string "[√ú]" "Ue" str t))
         (str (replace-regexp-in-string "[√ñ]" "Oe" str t))
         (str (replace-regexp-in-string "[√§]" "ae" str t))
         (str (replace-regexp-in-string "[√º]" "ue" str t))
         (str (replace-regexp-in-string "[√∂]" "oe" str t))
         (str (replace-regexp-in-string "[√ü]" "ss" str t))
         ;; Replace all characters except alphabets, numbers and
         ;; parentheses with spaces.
         (str (replace-regexp-in-string "[^[:alnum:]()]" " " str))
         ;; On emacs 24.5, multibyte punctuation characters like "Ôºö"
         ;; are considered as alphanumeric characters! Below evals to
         ;; non-nil on emacs 24.5:
         ;;   (string-match-p "[[:alnum:]]+" "Ôºö")
         ;; So replace them with space manually..
         (str (if (version< emacs-version "25.0")
                  (let ((multibyte-punctuations-str "Ôºö")) ;String of multibyte punctuation chars
                    (replace-regexp-in-string (format "[%s]" multibyte-punctuations-str) " " str))
                str))
         ;; Remove leading and trailing whitespace.
         (str (replace-regexp-in-string "\\(^[[:space:]]*\\|[[:space:]]*$\\)" "" str))
         ;; Replace 2 or more spaces with a single space.
         (str (replace-regexp-in-string "[[:space:]]\\{2,\\}" " " str))
         ;; Replace parentheses with double-hyphens.
         (str (replace-regexp-in-string "\\s-*([[:space:]]*\\([^)]+?\\)[[:space:]]*)\\s-*" " -\\1- " str))
         ;; Remove any remaining parentheses character.
         (str (replace-regexp-in-string "[()]" "" str))
         ;; Replace spaces with hyphens.
         (str (replace-regexp-in-string " " "-" str))
         ;; Remove leading and trailing hyphens.
         (str (replace-regexp-in-string "\\(^[-]*\\|[-]*$\\)" "" str)))
    str)
  )

(defun my/org-custom-id-from-id (&optional pom)
  (let ((pom (or pom (point))))
    (when (and (not-nil-p (org-id-get)) (not (org-entry-get (point) "CUSTOM_ID")))
      (org-set-property "CUSTOM_ID" (org-id-get)))))

(defun my/org-generate-custom-ids-from-ids ()
  (interactive)
  (save-excursion
    (widen)
    (goto-char (point-min))
    (org-map-entries (lambda () (my/org-custom-id-from-id (point))))))

(defun my/id-get-or-generate (&optional pom)
  "Returns the ID property if set or generates and returns a new one if not set.
 The generated ID is stripped off potential progress indicator cookies and
 sanitized to get a slug. Furthermore, it is prepended with an ISO date-stamp
 if none was found before."
  (interactive)
  (org-with-point-at pom
    (when (not (org-id-get))
      (let* (
             ;; TODO: Only get the raw text, i.e. ignore stuff like a link [[...]].
	         ;; retrieve heading string
    	     (my-heading-text (nth 4 (org-heading-components)))
             (my-heading-text (progn
                                (message "%s" my-heading-text)
                                (message "%s" (org-element-interpret-data (org-element-at-point)))
                                (org-element-interpret-data my-heading-text)))
		     ;; remove progress indicators like "[2/7]" or "[25%]"
		     (my-heading-text (replace-regexp-in-string "[[][0-9%/]+[]] " "" my-heading-text))
		     ;; get slug from heading text
             (new-id (my/generate-sanitized-alnum-dash-string my-heading-text))
    	     )
        (when (not (string-match "[12][0-9][0-9][0-9]-[01][0-9]-[0123][0-9]-.+" new-id))
          ;; only if no ISO date-stamp is found at the beginning of the new id:
          (setq new-id (concat (format-time-string "%Y-%m-%d-%H-%M-%S-") new-id)))
        (org-set-property "ID" new-id)
        )
      ))

  (org-id-get);; retrieve the current ID in any case as return value
  )

(setq org-id-link-to-org-use-id 'create-if-interactive-and-no-custom-id)

(defun my/org-add-ids-to-headlines-in-file ()
  "Add CUSTOM_ID properties to all headlines in the current
   file which do not already have one. Only adds ids if the
   `auto-id' option is set to `t' in the file somewhere. ie,
   #+OPTIONS: auto-id:t"
  (interactive)
  (save-excursion
    (widen)
    (goto-char (point-min))
    (org-map-entries (lambda () (my/id-get-or-generate (point))))))

;; ;; automatically add ids to saved org-mode headlines
;; (add-hook 'org-mode-hook
;;           (lambda ()
;;             (add-hook 'before-save-hook
;;                       (lambda ()
;;                         (when (and (eq major-mode 'org-mode)
;;                                    (eq buffer-read-only nil))
;;                           (my/org-add-ids-to-headlines-in-file))))))
#+end_src

*** Org-present
#+begin_src emacs-lisp 
;; `org-present'
(use-package org-present
  :ensure t)

(defun my/org-present-prepare-slide (buffer-name heading)
  ;; Show only top-level headlines
  (org-overview)

  ;; Unfold the current entry
  (org-show-entry)

  ;; Show only direct subheadings of the slide but don't expand them
  (org-show-children))

(defun my/org-present-start ()
  ;; Usually going to use `org-present-big' so we store the current settings and update.
  (setq-local org-present--org-format-latex-options org-format-latex-options)
  (setq-local org-format-latex-options '(:foreground default
                                                     :background default
                                                     :scale 3.0
                                                     :matchers ("begin" "$1" "$" "$$" "\\(" "\\[")))

  ;; Since the latex generated will be quite a different size, we use
  ;; a different output folder.
  (setq-local org-present--org-preview-latex-image-directory org-preview-latex-image-directory)
  (setq-local org-preview-latex-image-directory "~/.ltximg-present/")

  ;; Set a blank header line string to create blank space at the top
  (setq header-line-format " ")

  ;; Display inline images automatically
  (org-display-inline-images)

  ;; Center the presentation and wrap lines
  (visual-fill-column-mode 1)
  (visual-line-mode 1))

(defun my/org-present-end ()
  ;; (setq-local face-remapping-alist '((default default)))

  ;; Reset the latex preview stuff.
  (setq-local org-format-latex-options org-present--org-format-latex-options)
  (setq-local org-preview-latex-image-directory org-present--org-preview-latex-image-directory)
  
  ;; Clear the header line string so that it isn't displayed
  (setq header-line-format nil)

  ;; Stop displaying inline images
  (org-remove-inline-images)

  ;; Stop centering the document
  (visual-fill-column-mode 0)
  (visual-line-mode 0))

;; Register hooks with org-present
(add-hook 'org-present-mode-hook 'my/org-present-start)
(add-hook 'org-present-mode-quit-hook 'my/org-present-end)
(add-hook 'org-present-after-navigate-functions 'my/org-present-prepare-slide)
#+end_src

*** Org-rifle
#+begin_src emacs-lisp 
;; Useful for searching in org files.
;; Allows one to jump to a heading whose contents or itself has a match
;; with the search string.
(use-package helm-org-rifle
  :config
  (setq helm-org-rifle-show-path nil))
#+end_src

*** Org-contrib
#+begin_src emacs-lisp
;; Means that a heading with the `:ignore:` tag won't be exported, ONLY its contents will!
(use-package org-contrib)
(require 'ox-extra)
(ox-extras-activate '(ignore-headlines))
#+end_src

*** Hacks
**** Diff before tangle
This works but uncertain if I actually want it in the init-file or not.

#+begin_src emacs-lisp :results none :tangle no
;; Copy-paste of implementation that is present in built-in `org'
;; from This is GNU Emacs 27.1 (build 2, x86_64-pc-linux-gnu, GTK+ Version 3.24.20) of 2021-03-03.
;; The change is marked with HACK.
(defun org-babel-tangle (&optional arg target-file lang)
  "Write code blocks to source-specific files.
Extract the bodies of all source code blocks from the current
file into their own source-specific files.
With one universal prefix argument, only tangle the block at point.
When two universal prefix arguments, only tangle blocks for the
tangle file of the block at point.
Optional argument TARGET-FILE can be used to specify a default
export file for all source blocks.  Optional argument LANG can be
used to limit the exported source code blocks by language."
  (interactive "P")
  (run-hooks 'org-babel-pre-tangle-hook)
  ;; Possibly Restrict the buffer to the current code block
  (save-restriction
    (save-excursion
      (when (equal arg '(4))
	    (let ((head (org-babel-where-is-src-block-head)))
	      (if head
	          (goto-char head)
	        (user-error "Point is not in a source code block"))))
      (let ((block-counter 0)
	        (org-babel-default-header-args
	         (if target-file
		         (org-babel-merge-params org-babel-default-header-args
					                     (list (cons :tangle target-file)))
	           org-babel-default-header-args))
	        (tangle-file
	         (when (equal arg '(16))
	           (or (cdr (assq :tangle (nth 2 (org-babel-get-src-block-info 'light))))
		           (user-error "Point is not in a source code block"))))
	        path-collector)
	    (mapc ;; map over all languages
	     (lambda (by-lang)
	       (let* ((lang (car by-lang))
		          (specs (cdr by-lang))
		          (ext (or (cdr (assoc lang org-babel-tangle-lang-exts)) lang))
		          (lang-f (org-src-get-lang-mode lang))
		          she-banged)
	         (mapc
	          (lambda (spec)
		        (let ((get-spec (lambda (name) (cdr (assoc name (nth 4 spec))))))
		          (let* ((tangle (funcall get-spec :tangle))
			             (she-bang (let ((sheb (funcall get-spec :shebang)))
                                     (when (> (length sheb) 0) sheb)))
			             (tangle-mode (funcall get-spec :tangle-mode))
			             (base-name (cond
				                     ((string= "yes" tangle)
				                      (file-name-sans-extension
				                       (nth 1 spec)))
				                     ((string= "no" tangle) nil)
				                     ((> (length tangle) 0) tangle)))
			             (file-name (when base-name
				                      ;; decide if we want to add ext to base-name
				                      (if (and ext (string= "yes" tangle))
					                      (concat base-name "." ext) base-name))))
		            (when file-name
		              ;; Possibly create the parent directories for file.
		              (let ((m (funcall get-spec :mkdirp))
			                (fnd (file-name-directory file-name)))
			            (and m fnd (not (string= m "no"))
			                 (make-directory fnd 'parents)))
		              ;; delete any old versions of file
		              (and (file-exists-p file-name)
			               (not (member file-name (mapcar #'car path-collector)))
			               (progn
                             ;; HACK: Copy existing file to temporary folder before we delete.
                             (copy-file file-name (my/org-babel-tangle-backup-file-name file-name) t)
                             (delete-file file-name)))
		              ;; drop source-block to file
		              (with-temp-buffer
			            (when (fboundp lang-f) (ignore-errors (funcall lang-f)))
			            (when (and she-bang (not (member file-name she-banged)))
			              (insert (concat she-bang "\n"))
			              (setq she-banged (cons file-name she-banged)))
			            (org-babel-spec-to-string spec)
			            ;; We avoid append-to-file as it does not work with tramp.
			            (let ((content (buffer-string)))
			              (with-temp-buffer
			                (when (file-exists-p file-name)
			                  (insert-file-contents file-name))
			                (goto-char (point-max))
			                ;; Handle :padlines unless first line in file
			                (unless (or (string= "no" (cdr (assq :padline (nth 4 spec))))
					                    (= (point) (point-min)))
			                  (insert "\n"))
			                (insert content)
			                (write-region nil nil file-name))))
		              ;; if files contain she-bangs, then make the executable
		              (when she-bang
			            (unless tangle-mode (setq tangle-mode #o755)))
		              ;; update counter
		              (setq block-counter (+ 1 block-counter))
		              (unless (assoc file-name path-collector)
			            (push (cons file-name tangle-mode) path-collector))))))
	          specs)))
	     (if (equal arg '(4))
	         (org-babel-tangle-single-block 1 t)
	       (org-babel-tangle-collect-blocks lang tangle-file)))
	    (message "Tangled %d code block%s from %s" block-counter
		         (if (= block-counter 1) "" "s")
		         (file-name-nondirectory
		          (buffer-file-name
		           (or (buffer-base-buffer) (current-buffer)))))
	    ;; run `org-babel-post-tangle-hook' in all tangled files
	    (when org-babel-post-tangle-hook
	      (mapc
	       (lambda (file)
	         (org-babel-with-temp-filebuffer file
	           (run-hooks 'org-babel-post-tangle-hook)))
	       (mapcar #'car path-collector)))
	    ;; set permissions on tangled files
	    (mapc (lambda (pair)
		        (when (cdr pair) (set-file-modes (car pair) (cdr pair))))
	          path-collector)
	    (mapcar #'car path-collector)))))

;; My code.
(require 'f)

(defvar my/org-babel-tangle-backup-file-prefix "org-babel-tangle-backup--"
  "Prefix used for the temporary backup of previously tangled file.")

(defvar my/org-babel-tangle-diff-before-save t
  "Specifies whether to diff or not before commiting the tangle.")

(defun my/org-babel-tangle-backup-file-name (file-name)
  (f-join (temporary-file-directory) (concat my/org-babel-tangle-backup-file-prefix (f-filename file-name))))

;; Hook that opens a `diff' and queries the user as to whether
;; or not we should accept the changes.
(defun my/org-babel-tangle-backup-post-hook ()
  (let* ((file-name (buffer-file-name (current-buffer)))
         (tmp-file-name (my/org-babel-tangle-backup-file-name file-name)))
    (when my/org-babel-tangle-diff-before-save
      (save-window-excursion
        (diff tmp-file-name file-name)
        (unless (y-or-n-p "Apply changes?")
          (delete-file file-name)
          (f-move tmp-file-name file-name)
          (revert-buffer nil t t))))))

(add-hook 'org-babel-post-tangle-hook 'my/org-babel-tangle-backup-post-hook)
#+end_src
**** =ob-async=
#+begin_src emacs-lisp 
;; NOTE: Attempt at fixing issue with `ob-async'.
;; Source: https://github.com/astahlman/ob-async/issues/75#issuecomment-766783255
(use-package ob-async
  ;; :straight (:type git :host github :repo "astahlman/ob-async")
  ;; Handling of errors: https://github.com/astahlman/ob-async/issues/75#issuecomment-766783255
  ;; + some of my changes.
  :straight (:type git :host github :repo "torfjelde/ob-async" :branch "tor/develop")
  :config
  ;; NOTE: Fixes issue when interacting with `jupyter'.
  ;; https://github.com/nnicandro/emacs-jupyter/issues/383#issuecomment-1020919685
  (setq ob-async-no-async-languages-alist '("python" "julia" "jupyter-python" "jupyter-julia")))
#+end_src
**** Proper handling of ANSI color codes
#+begin_src emacs-lisp 
;; Source: https://emacs.stackexchange.com/a/63562
(defun ek/babel-ansi ()
  "Properly handle ANSI color codes in the result for a SRC block."
  ;; FIXME(torfjelde): I don't think this works if the result is a single line,
  ;; i.e. NOT wrapped in a `#+begin_example'.
  (when-let ((beg (org-babel-where-is-src-block-result nil nil)))
    (save-excursion
      (goto-char beg)
      (when (looking-at org-babel-result-regexp)
        (let ((end (org-babel-result-end))
              (ansi-color-context-region nil))
          (ansi-color-apply-on-region beg end))))))

(add-hook 'org-babel-after-execute-hook 'ek/babel-ansi)
#+end_src
**** Add helm-action which inserts URL or DOI
- This is quite useful when I just want to point someone to the paper.

#+begin_src emacs-lisp 
(defun tor/bibtex-insert-url-or-doi (keys)
  "Open the URL or DOI associated with entries in KEYS in a browser."
  (dolist (key keys)
    (let* ((entry (bibtex-completion-get-entry key))
           (url (bibtex-completion-get-value "url" entry))
           (doi (bibtex-completion-get-value "doi" entry))
           (browse-url-browser-function
            (or bibtex-completion-browser-function
                browse-url-browser-function)))
      (if url
          (insert url)
        (if doi
            (insert
             (s-concat "http://dx.doi.org/" doi))
          (message "No URL or DOI found for this entry: %s"
                   key))))))

(helm-bibtex-helmify-action tor/bibtex-insert-url-or-doi tor/helm-bibtex-insert-url-or-doi)

(setq helm-source-bibtex
  (helm-build-sync-source "BibTeX entries"
    :header-name (lambda (name)
                   (format "%s%s: " name (if helm-bibtex-local-bib " (local)" "")))
    :candidates 'helm-bibtex-candidates
    :filtered-candidate-transformer 'helm-bibtex-candidates-formatter
    :action (helm-make-actions
             "Open PDF, URL or DOI"       'helm-bibtex-open-any
             "Open URL or DOI in browser" 'helm-bibtex-open-url-or-doi
             "Insert citation"            'helm-bibtex-insert-citation
             "Insert reference"           'helm-bibtex-insert-reference
             "Insert BibTeX key"          'helm-bibtex-insert-key
             "Insert BibTeX entry"        'helm-bibtex-insert-bibtex
             "Insert URL or DOI"          'tor/helm-bibtex-insert-url-or-doi  ;; my addition
             "Attach PDF to email"        'helm-bibtex-add-PDF-attachment
             "Edit notes"                 'helm-bibtex-edit-notes
             "Show entry"                 'helm-bibtex-show-entry
             "Add PDF to library"         'helm-bibtex-add-pdf-to-library)))
#+end_src

** Anki
#+begin_src emacs-lisp 
(use-package anki-editor
  ;; Fork of `anki-editor.el' that seems to be working with the most recent version of AnkiConnect.
  :straight (:type git :host github :repo "orgtre/anki-editor")
  :init (progn
          (setq anki-editor-break-consecutive-braces-in-latex t)))
#+end_src

** Emacs anywhere
#+begin_src emacs-lisp
;; emacs-anywhere: https://github.com/zachcurry/emacs-anywhere
(defun github-conversation-p (app-name window-title)
  (and
   (string-match-p "google-chrome" (downcase app-name))
   (or (string-match-p "Pull Request" window-title)
       (string-match-p "Issue" window-title))))

(defun plutojl-p (app-name window-title)
  (and
   (string-match-p "google-chrome" (downcase app-name))
   ;; Last part of the window name should be `Pluto.jl'
   (string-match-p "Pluto\\.jl$" window-title)))

(defun popup-handler (app-name window-title x y w h)
  ;; Resize
  (set-frame-width (selected-frame) 250)
  (set-frame-height (selected-frame) 50)
  ;; set major mode
  (cond
   ((github-conversation-p app-name window-title) (poly-markdown-mode))
   ((plutojl-p app-name window-title) (julia-mode))
   ;; ...
   (t (poly-markdown-mode)) ; default major mode
   ))

;; NOTE: `ea-popup-hook' is used by `emacs-anywhere'.
(add-hook 'ea-popup-hook 'popup-handler)
#+end_src

** Email
#+begin_src emacs-lisp 
;; Email
;; Useful resources:
;; - https://kkatsuyuki.github.io/notmuch-conf/
;; - https://chrisdone.com/posts/emacs-mail/
;; - Multiple email setup:
;; - https://www.djcbsoftware.nl/code/mu/mu4e/Example-configurations.html#Example-configurations
;;   Example configurations using =mu=, but also invovles some setting of general mail variables
;;   and examples with `offlineimap'.
;; - https://emacs.stackexchange.com/a/12932
;;   Example using `smptmail-multi', which is _very_ useful.
;; - https://protesilaos.com/codelog/2021-05-15-emacs-notmuch/
;;   Demo of `notmuch'.
;; - https://sqrtminusone.xyz/posts/2021-02-27-gmail/
;;   Different approach to syncing with gmail using `lieer'. This also allows syncing tags with gmail.

(setq mail-user-agent 'message-user-agent)

;; Replies
(setq message-citation-line-function 'message-insert-formatted-citation-line)
(setq message-citation-line-format "\n\nOn %a, %d/%m/%Y, %f wrote:\n")

(use-package smtpmail-multi
  :ensure t)

;; Define the different accounts and their corresponding settings.
(setq smtpmail-multi-accounts
      '((tor-erlend95 . (
                         ;; `smtpmail-smtp-user'
                         "tor.erlend95@gmail.com"
                         ;; `smtpmail-smtp-server'
                         "smtp.gmail.com"
                         ;; `smtpmail-smtp-service'
                         587
                         ;; `mail-specify-envelope-from' will be set to `t', and `mail-envelope-from' will be set to the value
                         header
                         ;; `smptmail-stream-type'
                         starttls
                         ;; STARTTLS key (used to set `smptmail-starttls-credentials')
                         nil ;; TODO: is this correct?
                         ;; STARTTLS certificate (used to set `smtpmail-startttls-credentials')
                         nil ;; TODO: is this correct?
                         ;; `smtpmail-local-domain'
                         nil
                         ))
        (tor-github . ("tor.github@gmail.com" "smtp.gmail.com" 587 header starttls nil nil nil))

        ;; Set up to send email through local `davmail' instance.
        (tef30 . ("tef30@cam.ac.uk" "localhost" 1025 header nil))
        (dcsa-coms . ("dcsa_coms@darwin.cam.ac.uk" "localhost" 1025 header nil))))

;; Specify association rules for the different accounts.
(setq smtpmail-multi-associations '(("tor.erlend95@gmail.com" tor-erlend95)
                                    ("tor.github@gmail.com" tor-github)
                                    ("tef30@cam.ac.uk" tef30)
                                    ("dcsa_coms@darwin.cam.ac.uk" dcsa-coms)))

;; Make the send mail function use `smtpmail-multi-send-it'.
(setq message-send-mail-function 'smtpmail-multi-send-it)
;; Useful for debugging purposes.
(setq smtpmail-debug-info t)

;; Allow usage of org-mode to compose emails.
(use-package org-mime)
(setq org-mime-library 'mml)

;; `notmuch' and related.
;; Docs: https://notmuchmail.org/doc/latest/notmuch-emacs.html
(use-package notmuch
  :config
  (setq notmuch-always-prompt-for-sender t)
  (setq notmuch-saved-searches '((:name "inbox" :query "tag:inbox" :key "i")
                                 (:name "unread" :query "tag:unread" :sort-order newest-first :key "u")
                                 (:name "flagged" :query "tag:flagged" :sort-order newest-first :key "f")
                                 (:name "all mail" :query "*" :key "a")
                                 (:name "tor.erlend95" :query "tag:tor.erlend95" :sort-order newest-first :key "t")
                                 (:name "tef30" :query "tag:tef30" :sort-order newest-first :key "o")
                                 (:name "dcsa_coms" :query "tag:dcsa_coms" :sort-order newest-first :key "d")
                                 (:name "tor.github" :query "tag:tor.github" :sort-order newest-first :key "g")))
  )

;; Adds nice integration with `org-mode', e.g. storing of links.
(use-package ol-notmuch
  :ensure t)

;; Usually have to have point at the HTML to show it,
;; which is a bit annoying.
(defun notmuch-show-view-html+ ()
  "Open the text/html part of the current message using
`notmuch-show-view-part'."
  (interactive)
  (save-excursion
    (goto-char
     (prop-match-beginning
      (text-property-search-forward
       :notmuch-part
       "text/html"
       (lambda (value notmuch-part)
         (equal (plist-get notmuch-part :content-type)
                value)))))
    (notmuch-show-view-part)))

;; Custom HTML renderer for email which simply converts into the source.
;; Adapted version of `mm-shr'.
;; FIXME: When activating the `web-mode', we end up disabling the `notmuch' keybindings.
(defun my/mm-raw-html (handle)
  (let (charset coding char document)
    (mm-with-part (or handle (setq handle (mm-dissect-buffer t)))
      ;; Identify encoding.
      (setq case-fold-search t)
      (or (setq charset
		        (mail-content-type-get (mm-handle-type handle) 'charset))
	      (progn
	        (goto-char (point-min))
	        (and (re-search-forward "\
<meta\\s-+http-equiv=[\"']?content-type[\"']?\\s-+content=[\"']?\
text/html;\\s-*charset=\\([^\t\n\r \"'>]+\\)[^>]*>" nil t)
		         (setq coding (mm-charset-to-coding-system (match-string 1)
							                               nil t))))
	      (setq charset mail-parse-charset))
      ;; Decode and insert contents if it's not ASCII.
      (when (and (or coding
		             (setq coding (mm-charset-to-coding-system charset nil t)))
		         (not (eq coding 'ascii)))
	    (insert (prog1
		            (decode-coding-string (buffer-string) coding)
		          (erase-buffer)
		          (set-buffer-multibyte t))))
      ;; Go back to start of the buffer.
      (goto-char (point-min))
      (while (re-search-forward
	          "&#\\(?:x\\([89][0-9a-f]\\)\\|\\(1[2-5][0-9]\\)\\);" nil t)
	    (when (setq char
		            (cdr (assq (if (match-beginning 1)
				                   (string-to-number (match-string 1) 16)
				                 (string-to-number (match-string 2)))
			                   mm-extra-numeric-entities)))
	      (replace-match (char-to-string char))))
      ;; Remove "soft hyphens".
      (goto-char (point-min))
      (while (search-forward "¬≠" nil t)
	    (replace-match "" t t))
      ;; Set the `document' variable to the raw buffer contents.
      (setq document (buffer-string))
      )
    ;; Display.
    (save-restriction
      (narrow-to-region (point) (point))
      ;; Insert the HTML contents.
      (insert document)
      ;; Activate HTML mode.
      (web-mode)
      ;; Fontify so we get syntax highlighting and stuff.
      (font-lock-fontify-buffer)
      ;; Indent the buffer.
      (save-excursion
        (indent-region (point-min) (point-max) nil))
      ;; If we're at the beginning of the buffer, i.e. it's empty,
      ;; insert a newline.
      (unless (bobp)
	    (insert "\n"))
      (mm-handle-set-undisplayer
       handle
       (let ((min (point-min-marker))
             (max (point-max-marker)))
         (lambda ()
	       (let ((inhibit-read-only t))
	         (delete-region min max))))))))

;; (setq mm-text-html-renderer 'my/mm-raw-html)
(setq mm-text-html-renderer 'shr)

;; Handle attachments a bit better.
;; Source: https://notmuchmail.org/emacstips/#index2h2
(defun tor/mm-pipe-- (handle cmd)
  ;; conveniently, '-' '-' a args to pdftotext and docx2txt.pl work fine
  ;; fixme: naming inconsistency (fn name and buffer name)
  (let ((buffer (get-buffer-create "*attachment-to-text*")))
    (with-current-buffer buffer
      (setq buffer-read-only nil)
      (erase-buffer))
    (with-temp-buffer
      ;; "based on mm-pipe-part in mm-decode.el"
      (mm-with-unibyte-buffer
        (mm-insert-part handle)
        (mm-add-meta-html-tag handle)
        (let ((coding-system-for-write 'binary))
          (call-process-region (point-min) (point-max)
                               cmd nil buffer nil "-" "-"))))
    (pop-to-buffer buffer)
    (goto-char (point-min))
    (text-mode)
    (visual-line-mode)
    (view-mode)))

(defun tor/notmuch-show-pop-attachment-to-buffer ()
  ;; "based on `notmuch-show-apply-to-current-part-handle'"
  (interactive)
  (let ((handle (notmuch-show-current-part-handle)))
    (unwind-protect
        (pcase (car (nth 1 handle))
          ("application/pdf"
           ;; Save and open.
           ;; FIXME: Fails if we decide not to save the file, e.g.
           ;; because it would override an existing one.
           (find-file (notmuch-show-save-part))
           ;; Alternative: convert to text and open that buffer instead.
           ;; (tor/mm-pipe-- handle "pdftotext")
           )
          ("image/png"
           ;; Save and open.
           (find-file (notmuch-show-save-part))
           )
          ("application/vnd.openxmlformats-officedocument.wordprocessingml.document"
           (tor/mm-pipe-- handle "docx2txt.pl"))
          (_ (notmuch-show-save-part)))
      (kill-buffer (mm-handle-buffer handle)))))

(setq notmuch-show-part-button-default-action
      #'tor/notmuch-show-pop-attachment-to-buffer)

;; Overrides `org-notmuch-open' which apparently expects 2 arguments, while `org-mode'
;; (at least the one I've currently installed), expects 1 argument.
;; The 2nd argument in `org-notmuch-open' isn't used for anything anyways, so we might
;; as well just define one that ought to be compatible with either 1 or 2 args.
(defun org-notmuch-open (path &rest)
  "Follow a notmuch message link specified by PATH."
  (funcall org-notmuch-open-function path))
#+end_src

** Copilot
#+begin_src emacs-lisp 
(use-package company-box
  ;; :hook (company-mode . company-box-mode)
  )

(use-package copilot
  :straight (:host github
             :repo "zerolfx/copilot.el"
             :files ("dist" "*.el"))
  :ensure t
  :config
  (progn
    (add-hook 'prog-mode-hook 'copilot-mode)

    (with-eval-after-load 'company
      ;; disable inline previews
      (delq 'company-preview-if-just-one-frontend company-frontends)))

  (progn
    ;; Unbind deprecated navigation bindings from `company'.
    (require 'bind-key)
    (unbind-key "M-p" company-active-map)
    (unbind-key "M-n" company-active-map)

    ;; Add bindings for `copilot'
    (define-key copilot-completion-map (kbd "<tab>") 'copilot-accept-completion)
    (define-key copilot-completion-map (kbd "TAB") 'copilot-accept-completion)
    (define-key copilot-completion-map (kbd "M-p") 'copilot-previous-completion)
    (define-key copilot-completion-map (kbd "M-n") 'copilot-next-completion)
    (define-key copilot-completion-map (kbd "M-RET") 'copilot-accept-completion-by-word)
    (define-key copilot-completion-map (kbd "C-M-<return>") 'copilot-accept-completion-by-line)
    ))
#+end_src

** General stuff at the end
*** Frame name
#+begin_src emacs-lisp
;; Format the application/window name as "USER [PROJECT NAME]: FILE"
(setq-default frame-title-format
              '(:eval
                (format "%s [%s]: %s"
                        (or (file-remote-p default-directory 'user)
                            user-real-login-name)
                        ;; (or (file-remote-p default-directory 'host)
                        ;;     system-name)
                        (projectile-project-name)
                        (buffer-name)
                        )))
#+end_src

** =by-backend= to allow backend-specific header arguments
#+begin_src emacs-lisp 
(defmacro by-backend (&rest body)
  "Evaluate BODY for the given backends.
This uses `cl-case' to pick out the correct body for the current
backend, i.e. each element in BODY needs to be of the form
`(BACKEND BODY)'.

An example of using this to specify, say, whether a src-block
in Org-mode should be exported or not depending on the backend:

,#+begin_src emacs-lisp :exports (by-backend (html \"both\") (t \"none\"))
(+ 1 2)
,#+end_src

This will then export both code and result if the backend is HTML,
and nothing for all other backends."
  `(progn
     (cl-case org-export-current-backend ,@body)))
#+end_src

** Themes & styling
*** Themes
/Usually/, our main theme will either be =solarized-dark= or =solarized-light= (if we're outside).

#+begin_src emacs-lisp
(use-package solarized-theme
  :defer t
  ;; :init
  ;; (progn
  ;;   ;; Sets it to similar colors as the theme-colors; if `t' we use `dark' else we use `light'.
  ;;   ;; `solarized-dark' will have the "correct" midnight mode, so only do it if using `light'.
  ;;   ;; TODO: Implement `my/loaded-theme-is-solarized-light-p' or something similar
  ;;   (when (and (my/straight-installed-p 'pdf-tools) (my/loaded-theme-is-solarized-light-p))
  ;;     ;; (setq pdf-view-midnight-colors '("#556065" . "#fdf6e3"))
  ;;     ;; (setq pdf-view-midnight-colors '("#3f4446" . "#fdf6e3")) ;; slightly blacker font
  ;;     (setq pdf-view-midnight-colors '("#556065" . "#fff8e5")) ;; slightly brighter background
  ;;     ))
  )

(use-package darktooth-theme)
(use-package atom-one-dark-theme)

;; Load desired theme.
(load-theme 'doom-moonlight t)
(enable-theme 'doom-moonlight)  ;; ensures that fg-color and stuff is set correctly (I think)
#+end_src

Doom honestly has a bunch of nice features for their theme, so we might as well use some of them.

#+begin_src emacs-lisp
(use-package doom-themes)
;; (use-package spacegray-theme)

;; Adds red "alert" to modeline upon hitting `C-g` to interrupt a command, etc.
(doom-themes-visual-bell-config)
#+end_src

#+begin_src emacs-lisp
;; You must run (all-the-icons-install-fonts) one time after
;; installing this package!
(use-package all-the-icons
  :if (display-graphic-p))
#+end_src

#+begin_src emacs-lisp 
(defun tor/enable-theme-after (theme)
  "Run after loading THEME."
  ;; Ensures that the midnight mode has the correct colors set.
  (when (my/straight-installed-p 'pdf-tools)
    (setq pdf-view-midnight-colors `(,(face-attribute 'default :foreground) . ,(face-attribute 'default :background)))
    )

  ;; Change the directory for the latex preview fragments.
  ;; Otherwise, you run into issues where org-mode tries to render
  ;; cached versions of some latex which, because they were created in
  ;; a different theme, has the wrong colors.
  (setq org-preview-latex-image-directory (concat "~/.ltximg-" (symbol-name theme) "/"))
  )

(advice-add 'enable-theme :after #'tor/enable-theme-after)
#+end_src
*** Modeline
#+begin_src emacs-lisp
;; diminish.el: Allows us to hide certain mini-modes, if we so desire.
(use-package diminish)
#+end_src

#+begin_src emacs-lisp
(use-package minions
  :hook (doom-modeline-mode . minions-mode))

(use-package doom-modeline
  ;; :after eshell     ;; Make sure it gets hooked after eshell
  :hook (after-init . doom-modeline-init)
  :custom
  (doom-modeline-height 15)
  (doom-modeline-bar-width 6)
  (doom-modeline-lsp t)
  (doom-modeline-github nil)
  (doom-modeline-mu4e nil)
  (doom-modeline-irc t)
  (doom-modeline-minor-modes t)
  (doom-modeline-persp-name nil)
  (doom-modeline-buffer-file-name-style 'truncate-except-project)
  (doom-modeline-major-mode-icon nil))
#+end_src

* =init.el=
:PROPERTIES:
:header-args: emacs-lisp: :comments link :tangle no
:END:

** Global variables to set
#+name: el-global-variables
#+begin_src emacs-lisp
(setq
 desktop-restore-forces-onscreen nil ;; fixes an error occurring when using restoring `desktop'

 inhibit-startup-screen t
 inhibit-splash-screen t
 create-lockfiles nil
 column-number-mode t
 scroll-error-top-bottom t
 show-paren-delay 0.5
 use-package-always-ensure t
 sentence-end-double-space nil 
 global-prettify-symbols-mode t
 default-tab-width 4

 system-time-locale "C" ;; ensures that week-days follows English conbvention, e.g. Thu and Wed

 org-adapt-indentation nil  ;; don't indent text in a section to align with section-level
 org-export-allow-bind-keywords t  ;; allows us to set variables in setup-files for project
 org-preview-latex-image-directory "~/.ltximg/"  ;; this '/' at the end is VERY important..

 org-edit-src-content-indentation 0
 org-babel-inline-result-wrap "%s"
 org-emphasis-alist '(("*" bold)
		      ("/" italic)
		      ("_" default)
		      ("=" org-verbatim verbatim)
		      ("~" org-code verbatim)
		      ("+"
		       (:strike-through t)))

 bibtex-completion-pdf-field "file"

 ;; TeX stuff
 TeX-source-correlate-start-server t  ;; clicking in document takes you to source

 ;; set the backup folder to be the temp-folder
 backup-directory-alist `((".*" . ,temporary-file-directory))
 auto-save-file-name-transforms `((".*" ,temporary-file-directory t))

 ;; omnisharp-server-executable-path "/home/tor/omnisharp-server/Omnisharp/bin/Debug/OmniSharp.exe"

 ;; slime
 inferior-lisp-program "/usr/local/bin/sbcl"
 slime-lisp-implementations '((sbcl ("sbcl")))
 ;; lisp-indent-function 'common-lisp-indent-function
 ;; slime-complete-symbol-function 'slime-fuzzy-complete-symbol

 safe-local-variable-values '((visual-line-mode . 1)
			      (visual-line-mode . t)
			      (org-export-with-toc)
			      (org-after-todo-state-change-hook . tor/reading-list-done-hook)
			      (org-after-todo-state-change-hook . tor/impl-list-done-hook))
 )

(setq-default fill-column 100)
;; change the font-size a bit
(set-face-attribute 'default nil :height 77)
#+end_src

#+name: el-global-variables-final
#+begin_src emacs-lisp 
(setq
 system-time-locale "C" ;; ensures that week-days follows English convention, e.g. Thu and Wed
 )
#+end_src

** Additional customization

*** Fixing time-format across devices and locales
#+name: el-time-format-advice
#+begin_src emacs-lisp 
;; Ensures that we're always going to format the string according to EN locale.
;; Setting `system-time-locale' to `"C"' or something doesn't work for daemon-mode.
;; This is copy-paste from https://kisaragi-hiu.com/blog/2019-10-09-format-time-string-today.html.
(defun kisaragi/english-dow (&optional time zone abbreviated)
  "Return ABBREVIATED name of the day of week at TIME and ZONE.

If TIME or ZONE is nil, use `current-time' or `current-time-zone'."
  (unless time (setq time (current-time)))
  (unless zone (setq zone (current-time-zone)))
  (calendar-day-name
   (pcase-let ((`(,_ ,_ ,_ ,d ,m ,y . ,_)
                (decode-time time zone)))
     (list m d y))
   abbreviated))

(defun kisaragi/advice-format-time-string (func format &optional time zone)
  "Pass FORMAT, TIME, and ZONE to FUNC.

Replace \"%A\" in FORMAT with English day of week of today,
\"%a\" with the abbreviated version."
  (let* ((format (replace-regexp-in-string "%a" (kisaragi/english-dow time zone t)
                                           format))
         (format (replace-regexp-in-string "%A" (kisaragi/english-dow time zone nil)
                                           format)))
    (funcall func format time zone)))

	
(advice-add 'format-time-string :around #'kisaragi/advice-format-time-string)
#+end_src

*** Changing name of windows
#+name: el-window-name
#+begin_src emacs-lisp
;; Format the application/window name as "tor [project name]: file"
(setq-default frame-title-format
              '(:eval
                (format "%s [%s]: %s"
                        (or (file-remote-p default-directory 'user)
                            user-real-login-name)
                        ;; (or (file-remote-p default-directory 'host)
                        ;;     system-name)
                        (projectile-project-name)
                        (buffer-name)
                        )))
#+end_src

** Util
#+name: el-util
#+begin_src emacs-lisp
(defun clone-if-not-exists (remoteurl targetdir)
  (let* ((parentdir (file-name-directory (directory-file-name targetdir))))
    (when (not (file-directory-p targetdir))
      (message "%s not present; cloning from %s..." targetdir remoteurl)
      (if (eq (shell-command (format "git -C %s clone %s" parentdir remoteurl)) 0)
          (progn
            (message "Cloning of %s successful!" remoteurl)
            t)
        (progn
          (warn "Clong of %s FAILED!" remoteurl)
          nil)))))


(defun eval-and-replace ()
  "Replace the preceding sexp with its value."
  (interactive)
  (backward-kill-sexp)
  (condition-case nil
      (prin1 (eval (read (current-kill 0)))
             (current-buffer))
    (error (message "Invalid expression")
           (insert (current-kill 0)))))
;; (global-set-key (kbd "C-c e") 'eval-and-replace)


;; https://emacs.stackexchange.com/a/34900
(defun shell-command-on-region-and-select
    (start end command
           &optional output-buffer replace
           error-buffer display-error-buffer
           region-noncontiguous-p)
  "Wrapper for 'shell-command-on-region', re-selecting the output.

Useful when called with a selection, so it can be modified in-place"
  (interactive)
  (let ((buffer-size-init (buffer-size)))
    (shell-command-on-region
     start end command output-buffer replace
     error-buffer display-error-buffer
     region-noncontiguous-p)
    (setq deactivate-mark t)
    (setq end (+ end (- (buffer-size) buffer-size-init)))
    ;; (set-mark start)
    (goto-char end)
    (activate-mark)
    ))

;; (global-set-key (kbd "C-c e p") 'eval-and-replace)

;; Allows you to fold everything on a indentation-level greater than the current.
;; Source: https://stackoverflow.com/a/4459159
(defun aj-toggle-fold ()
  "Toggle fold all lines larger than indentation on current line"
  (interactive)
  (let ((col 1))
    (save-excursion
      (back-to-indentation)
      (setq col (+ 1 (current-column)))
      (set-selective-display
       (if selective-display nil (or col 1))))))
(global-set-key [(M C i)] 'aj-toggle-fold)

;; Tor's keybindings
(defun tor/duplicate-downward (begin end)
  "https://emacs.stackexchange.com/a/32515"
  (interactive "r")
  (let (deactivate-mark (point (point)))
    (insert (buffer-substring begin end))
    (push-mark point)))

;; https://stackoverflow.com/a/25212377/4956107
(defun rename-current-buffer-file ()
  "Renames current buffer and file it is visiting."
  (interactive)
  (let* ((name (buffer-name))
        (filename (buffer-file-name))
        (basename (file-name-nondirectory filename)))
    (if (not (and filename (file-exists-p filename)))
        (error "Buffer '%s' is not visiting a file!" name)
      (let ((new-name (read-file-name "New name: " (file-name-directory filename) basename nil basename)))
        (if (get-buffer new-name)
            (error "A buffer named '%s' already exists!" new-name)
          (rename-file filename new-name 1)
          (rename-buffer new-name)
          (set-visited-file-name new-name)
          (set-buffer-modified-p nil)
          (message "File '%s' successfully renamed to '%s'"
                   name (file-name-nondirectory new-name)))))))
#+end_src

** =sympy= integration
#+name: el-sympy
#+begin_src emacs-lisp
;; TODO: make of these sweeties
(defun eval-region-as-sympy-simplify ()
  "Evaluate selection as a python expression, replacing it with the result"
  (interactive)
  (shell-command-on-region-and-select
   (region-beginning)
   (region-end)
   "python -c 'import sys; from sympy import latex; from sympy.parsing.latex import parse_latex; sys.stdout.write(latex(parse_latex(str(sys.stdin.read())).simplify()))'" 0 t))

(defun eval-region-as-sympy-expand ()
  "Evaluate selection as a python expression, replacing it with the result"
  (interactive)
  (shell-command-on-region-and-select
   (region-beginning)
   (region-end)
   "python -c 'import sys; from sympy import latex; from sympy.parsing.latex import parse_latex; sys.stdout.write(latex(parse_latex(str(sys.stdin.read())).expand()))'" 0 t))

(defun eval-region-as-sympy-sum ()
  "Evaluate selection as a python expression, replacing it with the result"
  (interactive)
  (shell-command-on-region-and-select
   (region-beginning)
   (region-end)
   "python -c 'import sys; from sympy import latex; from sympy.parsing.latex import parse_latex; sys.stdout.write(latex(parse_latex(str(sys.stdin.read())).doit()))'" 0 t))

(defun eval-region-as-sympy-integrate ()
  "Evaluate selection as a python expression, replacing it with the result"
  (interactive)
  (shell-command-on-region-and-select
   (region-beginning)
   (region-end)
   "python -c 'import sys; from sympy import latex; from sympy.parsing.latex import parse_latex; sys.stdout.write(latex(parse_latex(str(sys.stdin.read())).integrate()))'" 0 t))
#+end_src
** Package manager setup
#+name: el-package-manager-setup
#+begin_src emacs-lisp
;; the package manager
(require 'package)
(setq
 package-archives '(("gnu" . "http://elpa.gnu.org/packages/")
                    ("org" . "http://orgmode.org/elpa/")
                    ("melpa" . "http://melpa.org/packages/")
                    ("melpa-stable" . "http://stable.melpa.org/packages/"))
 package-archive-priorities '(("melpa-stable" . 1)))

(package-initialize)
(when (not package-archive-contents)
  (package-refresh-contents)
  (package-install 'use-package))

;; notes about use-package ;;
;; :init - executes BEFORE loading package
;; :config - executes AFTER loading package
(require 'use-package)
#+end_src
** OS specific customization
#+name: el-os-specific
#+begin_src emacs-lisp
;; required by some OS specific stuff
(use-package exec-path-from-shell)

;;; OS specific variables ;;;
(cond
 ;; Windows
 ((string-equal system-type "windows-nt") ; Microsoft Windows
  (progn
    (message "Microsoft Windows")))
 
 ;; Mac OS X
 ;; We want to disable left-cmd and bind left-option to Meta
 ;; due to terminal apps using left-cmd for stuff, and I
 ;; want uniform bindings independent of the environment.
 ;; These variables are for this version of Emacs for Mac OS X:
 ;; https://bitbucket.org/mituharu/emacs-mac
 ((string-equal system-type "darwin") ; Mac OS X
  (progn
    (message "Mac OS X")
    (setq mac-command-modifier nil  ;; disables bindings to left-cmd on Mac
		  mac-option-modifier (quote (:ordinary meta :function alt :mouse alt))  ;; binds left-option to Meta
		  mac-right-option-modifier nil)  ;; disables it as a modifier so we can type properly, e.g. "[]|‚àû‚âà"
    (exec-path-from-shell-initialize)
	(setq racer-rust-src-path "/Users/tef/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/src/rust/src/")))

 ;; Linux
 ((string-equal system-type "gnu/linux") ; linux
  (progn
    (message "Linux")
    (exec-path-from-shell-initialize)            
	;; need to do `rustup component add rust-src' for `racer' to work
    (setq racer-rust-src-path "~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/")

    ;; use xclip to yank, allowing you to yank in terminal to the GLOBAL clipboard
    (use-package xclip
      :init (xclip-mode))
    )))
#+end_src
** Pretty
#+name: el-pretty
#+begin_src emacs-lisp
;; fancy letters
(defun pretty-greek ()
  (let ((greek '("alpha" "beta" "gamma" "delta" "epsilon" "zeta" "eta" "theta" "iota" "kappa" "lambda" "mu" "nu" "xi" "omicron" "pi" "rho" "sigma_final" "sigma" "tau" "upsilon" "phi" "chi" "psi" "omega")))
    (loop for word in greek
          for code = 97 then (+ 1 code)
          do  (let ((greek-char (make-char 'greek-iso8859-7 code))) 
                (font-lock-add-keywords nil
                                        `((,(concatenate 'string "\\(^\\|[^a-zA-Z0-9]\\)\\(" word "\\)[a-zA-Z]")
                                           (0 (progn (decompose-region (match-beginning 2) (match-end 2))
                                                     nil)))))
                (font-lock-add-keywords nil 
                                        `((,(concatenate 'string "\\(^\\|[^a-zA-Z0-9]\\)\\(" word "\\)[^a-zA-Z]")
                                           (0 (progn (compose-region (match-beginning 2) (match-end 2)
                                                                     ,greek-char)
                                                     nil)))))))))

;; prettify-list
(defun my-prettiest-symbols () 
  (setq prettify-symbols-alist
		'(
		  ("lambda" . 955) ; Œª
		  ("->" . 10140)    ; ‚Üí
		  ("=>" . 10233)    ; ‚áí
		  )))
#+end_src

** Package-specific
*** =pdf-tools=
#+name: el-pkg-pdf-tools
#+begin_src emacs-lisp
;; pdf-tools - much improved way to view pdfs
;; IMPORTANT: need to run `(pdf-tools-install)' to install dependencies
(use-package pdf-tools
  :pin melpa
  :mode ("\\.vpdf\\.?$" . pdf-virtual-edit-mode)
  :init (progn
          (if (string-equal system-type "gnu/linux") (pdf-tools-install))
          ;; copied from the source-code, but uses `org-mode' as default major-mode for text-annotations
          (setq pdf-annot-edit-contents-setup-function
                (lambda (a)
                   (let ((mode (if (funcall pdf-annot-latex-string-predicate
                                            (pdf-annot-get a 'contents))
                                   'latex-mode
                                 'org-mode)))
                     (unless (derived-mode-p mode)
                       (funcall mode)))))))
#+end_src
*** =auctex=
#+name: el-pkg-auctex
#+begin_src emacs-lisp
;; AucTeX
;; (require 'auctex)
(setq LaTeX-command-style '(("" "%(PDF)%(latex) -shell-escape %S%(PDFout)")))
;; Update PDF buffers after successful LaTeX runs
(add-hook 'TeX-after-compilation-finished-functions
          #'TeX-revert-document-buffer)
(add-hook 'LaTeX-mode-hook
          (lambda()
            (local-unset-key (kbd "C-c ]"))))

;; Adds label-completion
(use-package company-reftex
  :init (setq company-reftex-labels-regexp (rx "\\"
                                               ;; List taken from `reftex-ref-style-alist'
                                               (or "autoref"
                                                   "autopageref"
                                                   "Cpageref"
                                                   "cpageref"
                                                   "Cref"
                                                   "cref"
                                                   "eqref"
                                                   "Fref"
                                                   "fref"
                                                   "pageref"
                                                   "Ref"
                                                   "ref"
                                                   "vpageref"
                                                   "Vref"
                                                   "vref"
                                                   ;; custom stuff:
                                                   "propref"
                                                   "thmref"
                                                   "lemref"
                                                   "lemmaref"
                                                   "appref"
                                                   "assumptref"
                                                   "secref")
                                               "{"
                                               (group (* (not (any "}"))))
                                               (regexp "\\="))))
(use-package company-auctex
  :init (progn
          (company-auctex-init)
          (add-hook 'LaTeX-mode-hook 'company-mode)
          (add-hook 'latex-mode-hook 'company-mode)
          (add-hook 'LaTeX-mode-hook 'reftex-mode)

          ;; Means that we get
          (add-to-list 'company-backends 'company-reftex-labels)
          (add-to-list 'company-backends 'company-reftex-citations)
          ))
#+end_src
*** =anki-editor=
#+name: el-pkg-anki-editor
#+begin_src emacs-lisp 
;; anki-editor
(use-package anki-editor
  :pin melpa
  :init (progn
          (setq anki-editor-break-consecutive-braces-in-latex t)))
#+end_src
*** =flycheck=
#+name: el-pkg-flycheck
#+begin_src emacs-lisp 
;; flycheck
(use-package flycheck
  :pin melpa-stable
  :init
  (progn
	;; uncomment below if you're having issues with flycheck performance
	;; (setq 'flycheck-highlighting-mode 'lines) 
	(add-hook 'after-init-hook #'global-flycheck-mode)))
#+end_src
*** =company=
#+name: el-pkg-company
#+begin_src emacs-lisp 
;; company
(use-package company
  :config
  (progn
    (add-hook 'prog-mode-hook 'company-mode)
    (add-to-list 'company-backends '(company-jedi :with company-capf))
    (add-to-list 'company-backends 'ein:company-backend)
    (add-to-list 'company-backends '(company-irony-c-headers
                                     company-irony))))
;; Additional stuff
(use-package company-quickhelp)
#+end_src
*** =yasnippet=
#+name: el-pkg-yasnippet
#+begin_src emacs-lisp 
;; yasnippet
(use-package yasnippet
  :pin melpa-stable
  :init (progn
          (setq yas-triggers-in-field t ;; Enable nested triggering of snippets
                yas-indent-line 'fixed ;; Ensures that the indentation is done after my choosing
                )
          (yas-global-mode)))
#+end_src
*** =undo-tree=
#+name: el-pkg-undo-tree
#+begin_src emacs-lisp
(use-package undo-tree
  :diminish undo-tree-mode
  :init (global-undo-tree-mode))
#+end_src
*** =smartparens=
#+name: el-pkg-smartparens
#+begin_src emacs-lisp
(use-package smartparens
  :init
  (progn
    (require 'smartparens-config)
    (add-hook 'prog-mode-hook 'turn-on-smartparens-mode)
    (add-hook 'prog-mode-hook 'show-paren-mode t)))
#+end_src
*** =helm=
#+name: el-pkg-helm
#+begin_src emacs-lisp
(use-package helm
  :diminish helm-mode  ;; removes the helm-mode from the mode-line
  :init
  (progn
    (require 'helm-config)
    (helm-mode))
  :bind (("M-x" . helm-M-x)))
#+end_src
*** =helm-descbinds=
#+name: el-pkg-helm-descbinds
#+begin_src emacs-lisp
(use-package helm-descbinds
  :bind (("C-h b" . helm-descbinds)
	 ("C-h w" . helm-descbinds)))
#+end_src
*** =projectile=
#+name: el-pkg-projectile
#+begin_src emacs-lisp
(use-package projectile
  :diminish projectile-mode
  :config
  (progn
    (setq projectile-keymap-prefix (kbd "C-c p"))
    (setq projectile-completion-system 'default)
    (setq projectile-enable-caching t)
    (setq projectile-indexing-method 'alien)
    (add-to-list 'projectile-globally-ignored-files "node-modules")
    (projectile-global-mode)))

;; From their docs.
(use-package projectile
  :ensure t
  :init
  (projectile-mode +1)
  :config
  (progn
    (setq projectile-completion-system 'default)
    (setq projectile-enable-caching t)
    (setq projectile-indexing-method 'alien)
    ;; Some folders should always be ignored.
    (add-to-list 'projectile-globally-ignored-files "node-modules"))
  :bind (:map projectile-mode-map
              ("C-c p" . projectile-command-map)))
#+end_src
*** =multiple-cursors=
#+name: el-pkg-multiple-cursors
#+begin_src emacs-lisp
(use-package multiple-cursors
  :bind (("C->" . mc/mark-next-like-this)))
#+end_src
*** =avy=
#+name: el-pkg-avy
#+begin_src emacs-lisp
(use-package avy
  :bind ("M-j" . avy-goto-word-or-subword-1))
#+end_src
*** =ace-window=
#+name: el-pkg-ace-window
#+begin_src emacs-lisp
(use-package ace-window
  :config (global-set-key (kbd "M-[") 'ace-window))
#+end_src
*** =magit=
#+name: el-pkg-magit
#+begin_src emacs-lisp
(use-package magit
  :pin melpa
  :config (progn
            ;; Makes it so that the initial `magit' buffer will open in the current
            ;; window rather than opening in a different window.
            (setq magit-display-buffer-function
                  (lambda (buffer)
                    (display-buffer
                     buffer (if (and (derived-mode-p 'magit-mode)
                                     (memq (with-current-buffer buffer major-mode)
                                           '(magit-process-mode
                                             magit-revision-mode
                                             magit-diff-mode
                                             magit-stash-mode
                                             magit-status-mode)))
                                nil
                              '(display-buffer-same-window)))))))
#+end_src
*** =forge=
#+name: el-pkg-forge
#+begin_src emacs-lisp
;; (use-package forge
;;   :pin melpa)
#+end_src
*** =iedit=
#+name: el-pkg-iedit
#+begin_src emacs-lisp
(use-package iedit
  :bind ("C-c ,"))
#+end_src
*** =fic-mode=
#+name: el-pkg-fic-mode
#+begin_src emacs-lisp
;; provides highlighting for TODO, FIXME and BUG in comments
(use-package fic-mode
  :config
  (progn
    (add-hook 'prog-mode-hook #'fic-mode)
    (set-face-attribute 'fic-author-face nil :foreground "dark violet" :underline t)
    (set-face-attribute 'fic-face nil :foreground "magenta" :weight 'bold)
    (add-to-list 'fic-highlighted-words "HACK")
    (add-to-list 'fic-highlighted-words "NOTE")))
#+end_src
*** =edit-server=
This package is used together with the chrome-extension: https://chrome.google.com/webstore/detail/edit-with-emacs/ljobjlafonikaiipfkggjbhkghgicgoh/related?hl=en.

This means that if you have an Emacs daemon running on your computer you can simply click the Emacs-edit button on any text-box or whatever in Chrome and an Emacs window will pop up, allowing you to write in Emacs and then hit =C-c C-c= to insert into the browser!

#+name: el-pkg-edit-server
#+begin_src emacs-lisp 
(use-package edit-server
  :pin melpa
  :init (progn
          ;; Starts the edit server
          (edit-server-start)

          ;; We can set major-modes for different domains!!!
          (setq edit-server-url-major-mode-alist
                '(("github\\.com" . poly-markdown-mode)))
          )
  )
#+end_src
*** =vterm=
#+name: el-pkg-vterm
#+begin_src emacs-lisp 
(use-package vterm
  :config (setq vterm-buffer-name-string "*vterm [%s]*"))
#+end_src
*** Programming languages
**** General
#+name: el-pkg-lsp
#+begin_src emacs-lisp
(use-package lsp
  :pin melpa)
(use-package lsp-ui
  :pin melpa
  :config (progn
            ;; Don't show the code actions as it's a bit annoying
            (setq lsp-ui-sideline-show-code-actions nil)
            ;; Display documentation at-point
            (setq lsp-ui-doc-position 'at-point)

            ;; Sometimes we might want to disable `lsp-ui-doc-mode' so we
            ;; only get the docstring when we ask for it rather than by hover.
            (define-key lsp-ui-mode-map (kbd "C-c h") #'lsp-ui-doc-glance)
            (define-key lsp-ui-mode-map (kbd "C-c f") #'lsp-ui-doc-focus-frame)

            ;; Nicer to show doc at the top of the window rather than at the cursor.
            (setq lsp-ui-doc-position 'top)
            (setq lsp-ui-doc-alignment 'window)

            ;; Redefine some bindings for `xref' since `lsp-ui' provides similar
            ;; functionality.
            (define-key lsp-ui-mode-map
              [remap xref-find-definitions]
              #'lsp-ui-peek-find-definitions)
            (define-key lsp-ui-mode-map
              [remap xref-find-references]
              #'lsp-ui-peek-find-references)
            (define-key lsp-ui-mode-map
              [remap xref-find-apropos]
              #'lsp-ui-peek-find-workspace-symbol)
            )
  )

;; Make it work nicely with `treemacs`
(use-package lsp-treemacs
  :pin melpa)
#+end_src

#+name: el-prog-general
#+begin_src emacs-lisp 
(add-hook 'prog-mode-hook #'my-prettiest-symbols)
(add-hook 'prog-mode-hook #'display-line-numbers-mode)

(add-hook
 'prog-mode-hook
 (lambda ()
   ;; Fixes the width of the line-numbers; if I end up having to edit a file with more than 99 999 lines of code, I'll throw my computer through the wall anyways.
   (setq display-line-numbers-width 5)
   ;; Don't use word-wrap in programming mode; I want to see if it wraps
   (setq word-wrap nil)
   ;; Default to 100 linewidth in programming languages, because I like it.
   (set-fill-column 100)))

<<el-pkg-lsp>>
#+end_src

**** Markdown
#+name: el-prog-markdown
#+begin_src emacs-lisp 
(use-package markdown-mode
  :config (progn
            (setq-default markdown-spaces-after-code-fence 0)))
(use-package edit-indirect
  :config (progn
            (define-key edit-indirect-mode-map (kbd "C-c C-c") nil)))
#+end_src
**** C/C++
#+name: el-prog-c-and-cplusplus
#+begin_src emacs-lisp 
;; c/c++
;; replace the `completion-at-point' and `complete-symbol' bindings in
;; irony-mode's buffers by irony-mode's asynchronous function
(defun my-irony-mode-hook ()
  (define-key irony-mode-map [remap completion-at-point]
	'irony-completion-at-point-async)
  (define-key irony-mode-map [remap complete-symbol]
	'irony-completion-at-point-async))

(use-package irony
  :config
  (progn
	;; Windows performance tweaks
    (when (boundp 'w32-pipe-read-delay)
      (setq w32-pipe-read-delay 0))
    ;; Set the buffer size to 64K on Windows (from the original 4K)
    (when (boundp 'w32-pipe-buffer-size)
      (setq irony-server-w32-pipe-buffer-size (* 64 1024))))
  :init (progn
          ;; default to C++11
          (setq irony-additional-clang-options '("-std=c++11"))))

(use-package company-irony-c-headers)
(use-package company-irony)
(use-package cc-mode
  :bind (("C-c o" . ff-find-other-file)
	 ("C-c C-d" . my/duplicate-line))
  :config
  (progn
	(add-hook 'c++-mode-hook 'irony-mode)
    (add-hook 'c-mode-hook 'irony-mode)
    (add-hook 'objc-mode-hook 'irony-mode)

    ;; used to be set globally but this messed up when opening C files
    (add-hook 'c++-mode-hook (lambda () (setq flycheck-clang-language-standard "c++11")))
    (add-hook 'c++-mode-hook (lambda () (setq flycheck-gcc-language-standard "c++11")))

    (add-hook 'irony-mode-hook 'my-irony-mode-hook)
    (c-set-offset 'case-label '+)
    (sp-local-pair 'c-mode "{" nil :post-handlers '((my/open-block-c-mode "RET")))
    (sp-local-pair 'c++-mode "{" nil :post-handlers '((my/open-block-c-mode "RET")))))
#+end_src
**** Arduino
#+name: el-prog-arduino
#+begin_src emacs-lisp 
(use-package arduino-mode
  :mode "\.\\(pde\\|ino\\).?$"
  :config (sp-local-pair 'arduino-mode
			 "{" nil :post-handlers '((my/open-block-c-mode "RET"))))
#+end_src
**** Lisp
#+name: el-prog-lisp
#+begin_src emacs-lisp 
;; lisp
;; (add-to-list 'load-path "/Users/tef/quicklisp/dists/quicklisp/software/slime-2.14")
;; (require 'slime)
(defvar slime-repl-font-lock-keywords lisp-font-lock-keywords-2)
(defun slime-repl-font-lock-setup ()
  (setq font-lock-defaults
		'(slime-repl-font-lock-keywords
		  ;; From lisp-mode.el
		  nil nil (("+-*/.<>=!?$%_&~^:@" . "w")) nil
		  (font-lock-syntactic-face-function
		   . lisp-font-lock-syntactic-face-function))))

(defadvice slime-repl-insert-prompt (after font-lock-face activate)
	(let ((inhibit-read-only t))
	  (add-text-properties
	   slime-repl-prompt-start-mark (point)
	   '(font-lock-face
		 slime-repl-prompt-face
		 rear-nonsticky
		 (slime-repl-prompt read-only font-lock-face intangible)))))

;; COMMENTED SLIME for a faster startup => uncomment if you want to use it
;; (add-to-list 'load-path "/Users/tef/.emacs.d/elpa/slime-2.19/contrib/")
;; (use-package "slime-company")
;; (use-package "slime"
;;   ;; :mode "\\.lisp\\.?$"
  
;;   :init
;;   (progn
;; 	;; (require 'slime-repl)
;; 	;; (add-hook 'slime-repl-mode-hook 'slime-repl-font-lock-setup)
;; 	(setq slime-net-coding-system 'utf-8-unix)
;; 	(slime-setup '(slime-fancy slime-company))
;; 	(slime-setup '(slime-fancy slime-company))
;; 	(setq slime-enable-evaluate-in-emacs t)
;; 	))

(use-package "eldoc"
  :diminish eldoc-mode
  :commands turn-on-eldoc-mode
  :defer t
  :init
  (progn
  (add-hook 'emacs-lisp-mode-hook 'turn-on-eldoc-mode)
  (add-hook 'lisp-interaction-mode-hook 'turn-on-eldoc-mode)
  (add-hook 'ielm-mode-hook 'turn-on-eldoc-mode)))
#+end_src
**** Clojure
#+name: el-prog-clojure
#+begin_src emacs-lisp 
;; clojure
(use-package clojure-mode)
(use-package cider
  :init
  (progn
    (setq cider-cljs-lein-repl
	  "(do (require 'figwheel-sidecar.repl-api)
		   (figwheel-sidecar.repl-api/start-figwheel!)
		   (figwheel-sidecar.repl-api/cljs-repl))")))
#+end_src
**** Rust
#+name: el-prog-rust
#+begin_src emacs-lisp 
;; rust
(use-package rust-mode
  :init
  (progn
    ;; (add-hook 'rust-mode-hook 'flycheck-rust-setup)  ;; newly added
	(add-hook 'rust-mode-hook 'pretty-greek)
	(add-hook 'rust-mode-hook 'my-prettiest-symbols)))
(use-package racer
  :bind (("C-c TAB" . company-indent-or-complete-common))
  :init
  (progn
    (add-hook 'rust-mode-hook #'racer-mode)
    (add-hook 'rust-mode-hook #'eldoc-mode)
    (setq company-tooltip-align-annotations t)))
(use-package company-racer)
#+end_src
**** Scala
#+name: el-prog-scala
#+begin_src emacs-lisp 
;; scala
(use-package scala-mode
  :pin melpa-stable
  :mode "\\.scala\\.?$")
;; FIXME: apparently `ensime' is done for, and it's replaced by something called `metals'. Probably never going to do Scala again though, so whatever
;; (use-package ensime
;;   :pin melpa-stable)
#+end_src
**** Groovy
#+name: el-prog-groovy
#+begin_src emacs-lisp 
;; groovy
(use-package groovy-mode
  :config
  (progn
    (sp-local-pair 'c-mode "{" nil :post-handlers '((my/open-block-c-mode "RET")))))
#+end_src
**** C#
#+name: el-prog-csharp
#+begin_src emacs-lisp 
;; c# / c-sharp
(use-package csharp-mode
  :mode "\\.cs\\.?$"
  :pin melpa-stable
  :config (sp-local-pair 'csharp-mode "{" nil :post-handlers '((my/open-block-c-mode "RET"))))

;; (use-package omnisharp
;;   :init (setq omnisharp-server-executable-path "/Users/tef/omnisharp-server/Omnisharp/bin/Debug/OmniSharp.exe")
;;   :config (add-to-list 'company-backends 'company-omnisharp))
#+end_src
**** Golang
#+name: el-prog-golang
#+begin_src emacs-lisp 
;; Golang
(use-package go-mode
  :mode "\\.go\\.?$"
  :pin melpa-stable
  :config (add-to-list 'company-backends 'company-go))
(use-package company-go)
#+end_src
**** Jupyter
#+name: el-prog-jupyter
#+begin_src emacs-lisp 
(use-package jupyter
  :pin melpa
  :after (polymode org)
  :config (progn
	    (setq org-babel-default-header-args:jupyter-julia '((:async . "yes")
								(:session . "jl")
								(:kernel . "julia-1.3")))
	    (setq org-babel-default-header-args:jupyter-python '((:async . "yes")
								 (:session . "py")
								 (:kernel . "python3")))

            ;; Set `polymode-eval-region-function' to `jupyter-eval-region'
            ;; so we can evaluate in REPL using `M-n v v'.
            (add-hook 'jupyter-repl-interaction-mode-hook #'poly-jupyter-mode-setup)
            ;; Make the keybinding `C-c '' work INSIDE of the code blocks too.
            ;; Combined with the above hook to `jupyter-repl-interaction', we can
            ;; run `jupyter-run-repl' with the cursor inside a code-block to associate a
            ;; buffer to all such code-blocks in this buffer. Then, to ensure that the indirect
            ;; buffer opened using `iedit-indirect-region', we set `jupyter-current-client'
            ;; to the value which it has in the innerchunk that we executed
            ;; `markdown-edit-code-block' in.
            (add-hook
             'jupyter-repl-interaction-mode-hook
             (lambda ()
               (setq-local edit-indirect-after-creation-hook
                           `(lambda () (setq jupyter-current-client ,jupyter-current-client)))))))
#+end_src
**** Julia
#+name: el-prog-julia
#+begin_src emacs-lisp 
;; Julia
(use-package julia-mode
  :config
  (progn
    (add-hook
     'julia-mode-hook
     (lambda ()
       ;; shift such that it wraps only if it goes beyond 91
       (set-fill-column (+ 91 display-line-numbers-width 2)))))
  ;; :config
  ;; (progn
  ;;   ;; (load "ess-site")
  ;;   ;; (add-hook 'julia-mode #'ess-julia-mode)
  ;;   ;; overwrite this rebinding from `ess-julia-mode'
  ;;   ;; (bind-key "TAB" 'julia-latexsub-or-indent ess-julia-mode-map))
  )

(use-package julia-repl)

;; The `lsp' setup for Julia
;; You might need to dev both `LanguageServer.jl' and `StaticLint.jl'
;; for everything to work (at least I had to on 02/03/2021).
(use-package lsp-julia
  :pin melpa
  :config (progn
            (setq lsp-julia-package-dir nil)
            (setq lsp-julia-default-environment "~/.julia/environments/v1.5")))
#+end_src
**** Web
#+name: el-prog-web
#+begin_src emacs-lisp 
;; web development
;; from FAQ at http://web-mode.org/ for smartparens
(defun my/web-mode-hook ()
  (setq web-mode-enable-auto-pairing nil))

(defun my/sp-web-mode-is-code-context (id action context)
  (and (eq action 'insert)
       (not (or (get-text-property (point) 'part-side)
                (get-text-property (point) 'block-side)))))

(defun setup-tide-mode ()
  (interactive)
  (tide-setup)
  (flycheck-mode +1)
  (setq flycheck-check-syntax-automatically '(save mode-enabled))
  (eldoc-mode +1)
  (tide-hl-identifier-mode +1)
  ;; company is an optional dependency. You have to
  ;; install it separately via package-install
  ;; `M-x package-install [ret] company`
  (company-mode +1))

(use-package tide)

(use-package web-mode
  :mode "\\.\\(html?\\|jinja||tsx\\).$"
  :config
  (progn
    (add-hook 'web-mode-hook  'my/web-mode-hook)
    ;; setup Tide with web-mode
    (add-hook 'web-mode-hook
          (lambda ()
            (when (string-equal "tsx" (file-name-extension buffer-file-name))
              (setup-tide-mode))))
    
    (sp-local-pair 'web-mode "<" nil :when '(my/sp-web-mode-is-code-context))
    (setq web-mode-markup-indent-offset 2)
    (setq web-mode-code-indent-offset 2)
    (setq web-mode-enable-current-element-highlight t)
    (setq web-mode-ac-sources-alist
	  '(("css" . (ac-source-css-property))
	    ("html" . (ac-source-words-in-buffer ac-source-abbrev)))
	  )))

;; Allows for 'div.className' + C-j => "<div class='className'></div>"
(use-package emmet-mode
     :init
     (progn
       (add-hook 'web-mode-hook 'emmet-mode)))
(use-package helm-emmet)

;; javascript
(use-package js2-mode)
(use-package rjsx-mode
  :mode "\\.js\\.?$"
  :config (setq js-indent-level 2))
(use-package skewer-mode
  :init
  (progn
    ;; disable warning on missing semi-colons
    (setq js2-strict-missing-semi-warning nil
          js2-missing-semi-one-line-override nil)
    
    (add-hook 'js2-mode-hook 'skewer-mode)
    (add-hook 'css-mode-hook 'skewer-css-mode)
    (add-hook 'html-mode-hook 'skewer-html-mode))
  :config (skewer-setup))

;; js autocomplete server. Requires "npm install -g tern" too.
(use-package tern
  :config
  (progn
    (bind-key "C-c C-c" 'compile tern-mode-keymap)
    (when (eq system-type 'windows-nt) (setq tern-command '("cmd" "/c" "tern")))
    (add-hook 'js2-mode-hook 'tern-mode)
    (add-hook 'rjsx-mode-hook 'tern-mode)
    (setq company-tern-property-marker nil)))

(use-package company-tern
  :init (add-to-list 'company-backends 'company-tern))

;; typescript
(use-package typescript-mode
  :init (sp-local-pair 'csharp-mode "{" nil :post-handlers '((my/open-block-c-mode "RET"))))
#+end_src
**** R
#+name: el-prog-R
#+begin_src emacs-lisp 
;; R
(use-package ess
  :pin melpa-stable)
#+end_src
**** Python
#+name: el-prog-python
#+begin_src emacs-lisp 
;; python
(use-package jedi
  :pin melpa-stable
  :config
  (progn
    (setq jedi:environment-virtualenv (list "virtualenv" "--system-site-packages"))
    (jedi:setup)))

(use-package company-jedi
  :pin melpa-stable)

(use-package elpy
  :pin melpa
  :config
  (progn
    (when (require 'flycheck nil t)
	  (setq elpy-modules (delq 'elpy-module-flymake elpy-modules))
	  (add-hook 'elpy-mode-hook 'flycheck-mode)))
  )

(use-package python
  :mode ("\\.py\\.?$" . python-mode)
  :pin melpa-stable
  :config
  (progn
	(add-hook 'python-mode-hook 'pretty-greek)
    ;; (add-hook 'python-mode-hook 'jedi-mode)
	(add-hook 'python-mode-hook 'elpy-mode)
    (add-hook 'python-mode-hook
	  (lambda ()
	    (progn
	      (setq electric-indent-chars (delq ?: electric-indent-chars)))))
    ))

(use-package ein
  :init (progn
          ;; BUG: this does not currently work for some reason; also I think I need it
          ;; (setq ein:use-smartrep t)
          (add-hook 'ein:notebook-mode-hook 'company-mode)))
#+end_src
**** Haskell
#+name: el-prog-haskell
#+begin_src emacs-lisp 
;; haskell
(use-package haskell-mode
  :mode "\\.hs\\.?$"
  :init (progn
		  ;; buffer-local variable so to use `hlint'
		  ;; had performance issues with using `stack-ghc-lint'
		  (add-hook 'haskell-mode-hook
					(lambda ()
					  (setq flycheck-checker 'haskell-ghc)))))
#+end_src
**** Lua
#+name: el-prog-lua
#+begin_src emacs-lisp 
;; Lua
(use-package lua-mode
  :pin melpa
  :mode "\\.lua?$")
#+end_src

*** =visual-fill-column=
#+name: el-pkg-visual-fill-column
#+begin_src emacs-lisp 
(use-package visual-fill-column
  :init (progn
          (setq-default visual-fill-column-center-text t)
          (add-hook 'visual-line-mode-hook #'visual-fill-column-mode)

          ;; This will mess up a lot of the stuff from `lsp-ui', so
          ;; we deactivate by default.
          ;; (add-hook 'prog-mode-hook #'visual-fill-column-mode)
          ))
#+end_src
*** Org-mode
#+name: el-org-mode
#+begin_src emacs-lisp 
;; org-mode
(defmacro tor/with-local (var val &rest body)
  "Utility temporarily setting setting VAR to VAL and exectuting BODY in this context, then restoring the value of the variable."
  `(let ((prev ,var)
	 (res nil))
     (setq ,var ,val)
     (setq res (progn ,@body))
     (setq ,var prev)
     res))

(defvar tor/latex-publish-directory "./.latex/")

(defun tor/blog-dir-as-relative (dir filename)
  (file-relative-name dir (file-name-directory filename)))

(defun tor/blog-get-latex-directory (plist filename pub-dir)
  (cond
   ((plist-member plist :latex-directory) (file-relative-name (plist-get plist :latex-directory) (file-name-directory filename)))
   ;; ((plist-member plist :assets-directory) (file-relative-name (concat (plist-get plist :assets-directory) "latex/") (file-name-directory filename)))
   ((plist-member plist :project-directory) (file-relative-name (concat (plist-get plist :project-directory) "assets/latex/") (file-name-directory filename)))))

;; TODO: create a customized publishing function
(defun tor/org-html-publish-to-html (plist filename pub-dir)
  "My customized HTML publishing function. Publish an org file to HTML.

PLIST is the property list of the given object.
FILENAME is the filename of the Org file to be published. 
PUB-DIR is the publishing directory.

Return output file name."
  ;; TODO: need to update/republish "local" index if it exists
  (tor/with-local org-preview-latex-image-directory
		  (or (tor/blog-get-latex-directory plist filename pub-dir)
		      tor/latex-publish-directory)
		  (org-html-publish-to-html plist filename pub-dir)))

(defun tor/publish-html (plist filename pub-dir)
  (message "%s" plist)
  (message "%s" filename)
  (message "%s" pub-dir)
  (copy-file filename (concat pub-dir (file-name-nondirectory filename)) t)
  (concat pub-dir (file-name-nondirectory filename)))

;; TODO: format paths properly to avoid recursion and so on.
(defun tor/org-publish-attachment (plist filename pub-dir)
  "Publish a file with no transformation of any kind.

PLIST is the property list for the given project.
FILENAME is the filename of the Org file to be published.  
PUB-DIR is the publishing directory.

Return output file name."
  (org-publish-attachment plist filename pub-dir))

(defun tor/org-publish-attachment-local (plist)
  "Use PLIST to copy the entire base-directory to publishing-directory."
  (shell-command (concat "cp -r " (plist-get plist :base-directory) "/* " (plist-get plist :publishing-directory) "/")))

(defun tor/filename-to-title (filename)
  "Transform FILENAME into title by splitting on _ and concatenating."
  (string-join
   (mapcar #'capitalize
	   (split-string (string-remove-suffix ".org" filename) "\[-_ \]" t))
   " "))

(use-package mustache
  :config (require 'ht))

(defun tor/directory-p (d)
  (string-match-p "\\." d))

(defun tor/dir-has-index-file-p (d)
  (let* ((subdirs (directory-files (concat "~/org-blog/notes/" d)))
        (result (-find (lambda (x) (string-equal x "index.org")) subdirs)))
    (not (equal result nil))))

(defun tor/org-file-p (p)
  (string-match-p "\\.org" p))

(defun tor/not-org-file-p (p)
  (not (tor/org-file-p p)))

(defun tor/posts-render-front-page (files)
  (let ((mustache-partial-paths '("~/org-blog/templates/"))
	(base-dir (file-truename (plist-get export-options :publishing-directory))))
    (mustache-render "{{> posts }}"
		     (ht ("posts"
			  (-map
			   (lambda (c) (ht ("title" (tor/filename-to-title c))
				      ("link" (concat base-dir c))))
			   (remove-if #'tor/not-org-file-p (directory-files "~/org-blog/posts/"))))))))

(defun tor/prepare-blog-post-publish (export-options)
  (let ((files (remove-if #'tor/not-org-file-p (directory-files "~/org-blog/posts/")))
	(mustache-partial-paths '("~/org-blog/templates/"))
	(base-dir (file-truename (plist-get export-options :publishing-directory))))
    (with-temp-buffer
      (insert (mustache-render "{{> posts }}"
			       (ht ("posts"
				    (-map
				     (lambda (c) (ht ("title" (tor/filename-to-title c))
						("link" (replace-regexp-in-string "\\.org" ".html" c))))
				     files)))))
      (write-region nil nil "~/org-blog/posts/index.html"))))

(defun tor/render-html-preamble (export-options)
  "Renders the HTML preamble. EXPORT-OPTIONS refers to the export options passed by org."
  ;; FIXME: figure out a better way to load this on demand
  (require 'mustache)
  (require 'ht)

  (let ((mustache-partial-paths '("~/org-blog/templates/"))
	(base-dir (file-truename (plist-get export-options :base-directory)))
	(input-file (file-truename (plist-get export-options :input-file))))
    (message base-dir)
    (mustache-render "{{> base }}"
		     (ht ("categories"
			  (-map
			   (lambda (c) (ht ("category" (tor/filename-to-title c))
				      ("link" (concat (file-relative-name
						       (concat base-dir "/" c)
						       (file-name-directory input-file))
						      "/index.html"))))
			   (-filter #'tor/dir-has-index-file-p
                                    (remove-if #'tor/directory-p (directory-files "~/org-blog/notes/")))))))))

(defun tor/render-html-postamble (export-options)
  "Renders the HTML post-amble. EXPORT-OPTIONS refers to the export options passed by org."
  (require 'mustache)
  ;; (require 'ht)

  (let ((mustache-partial-paths '("~/org-blog/templates/")))
    (mustache-render "{{> footer}}" (ht ("" nil)))))

(defun tor/render-html-preamble--posts (export-options)
  "Renders the HTML preamble for blog-posts. EXPORT-OPTIONS refers to the export options passed by org."
  ;; FIXME: figure out a better way to load this on demand
  (require 'mustache)
  (require 'ht)

  (let ((mustache-partial-paths '("~/org-blog/templates/"))
	(base-dir (file-truename (plist-get export-options :publishing-directory))))
    (message base-dir)
    (mustache-render "{{> base }}"
		     (ht ("categories"
			  `(,(ht ("category" "Posts") ("link" "index.html"))
			    ,(ht ("category" "Wiki") ("link" "../notes/index.html"))
			    ,(ht ("category" "Notes from papers") ("link" "../papers/index.html"))
			    ,(ht ("category" "About me") ("link" "../about.html"))))))))

(defun tor/element--sort-elements-by-raw-value (el1 el2)
  "Compare :raw-value of EL1 and EL2, returning true if EL2 > EL1."
  (string-greaterp (org-element-property :raw-value el2)
		   (org-element-property :raw-value el1)))

(defun tor/element--get-begin (el)
  "Get beginning of EL."
  (org-element-property :begin el))

(defun tor/element--get-end (el)
  "Get end of EL."
  (org-element-property :end el))

(defun tor/reading-list-sort (&optional level)
  "Sort reading list at LEVEL."
  (interactive)
  (let* ((i 0)
	 (headline-level (or level 1))
	 (parsed (org-element-parse-buffer))
	 (headlines (-filter (lambda (el) (= (org-element-property :level el) headline-level)) 
			    (org-element-map parsed 'headline 'identity)))
	 (start (-min (-map 'tor/element--get-begin headlines)))
	 (end (-max (-map 'tor/element--get-end headlines))))
    (delete-region start end)
    (goto-char start)
    (insert (string-join
	     ;; TODO: update indices
	     (-map
	      (lambda (el)
		(progn
		  (setq i (+ i 1))
		  (replace-regexp-in-string "* TODO [0-9]+\\."
					    (format "* TODO %03d." i)
					     el)))
	      (-map 'org-element-interpret-data
			 (sort headlines 'tor/element--sort-elements-by-raw-value)))
	     ""))))

(defun tor/reading-list--get-next-idx (&optional level category)
  "Get index for reading list at LEVEL and ."
  (let* ((headline-level (or level 1))
	 (parsed (org-element-parse-buffer))
	 (headlines (-filter (lambda (el) (and (= (org-element-property :level el) headline-level)
					  ;; FIXME: BROKEN. Grab this from the property-drawer
					  (if category
					      (org-element-property :category el)
					    t)))
			     (org-element-map parsed 'headline 'identity))))
    (+ 1 (-max
	  (or (-filter
	       (lambda (x) (not (= x 0)))
	       (-map (lambda (el)
		       (string-to-number
			(car (split-string
			      (org-element-property :raw-value el) "\\."))))
		     headlines))
	      '(0))))))

(defun tor/list-done-hook (filename)
  "Remove number of completed todo and re-sort reading list."
  (when (and (boundp 'org-state) (string-equal org-state "DONE"))
    (save-excursion
      (with-current-buffer (find-file-noselect filename)
	(goto-char (point-min))
	;; ONLY match one instead of going on a spree here
	(if (re-search-forward "* DONE \\([0-9]+\\)\\." nil t)
	    ;; replace the completed heading            
	    (let ((n (string-to-number (buffer-substring (match-beginning 1) (match-end 1)))))
	      (message (buffer-substring (match-beginning 0) (match-end 0)))
	      (replace-match "* DONE" nil nil nil 0)
	      ;; search for next headings which need to be updated; +1 to their number
	      (message (number-to-string (point)))
	      (message (buffer-name))
	      (goto-char (match-end 0))
	      (while (re-search-forward "* TODO [0-9]+\\." nil t)
		(message (number-to-string n))
		(replace-match (format "* TODO %03d." n))
		(setf n (+ n 1)))))
	;; sort reading-list
	(tor/reading-list-sort)
	))))

(defun tor/reading-list-next-idx ()
  (save-excursion
    (with-current-buffer (find-file-noselect "~/Dropbox/org/reading.org")
      (format "%03d" (tor/reading-list--get-next-idx)))))

;; used to have this `-*- org-after-todo-state-change-hook: tor/reading-list-done-hook; -*-'
;; at the top of `reading.org', but it doesn't quite work for some reason
;; ACTUALLY this is not what's causing the issue I believe, so I reactivated it.
(defun tor/reading-list-done-hook ()
  (tor/list-done-hook "~/Dropbox/org/reading.org"))

(defun tor/impl-list-next-idx ()
  (save-excursion
    (with-current-buffer (find-file-noselect "~/Dropbox/org/implement.org")
      (format "%03d" (tor/reading-list--get-next-idx)))))

(defun tor/impl-list-done-hook ()
  (tor/list-done-hook "~/Dropbox/org/implement.org"))

;; TODO: setup this to properly work
;; currently having issues with inactive timestamps used in the appointments
(defun tor/clocks-to-clocked-string (start end)
  (format "%s--%s"
	  (format-time-string "[%Y-%m-%d %H:%M]" start)
	  (format-time-string "[%Y-%m-%d %H:%M]" end)))

(defun tor/appt-fake-clock-hook ()
  "Create 'fake' clock-in and clock-out entry for appointment with time-range."
  (org-back-to-heading)
  (let* ((hl (org-element-headline-parser 1000))
	 (sch (org-element-property :scheduled hl))
	 (closed (org-element-property :closed hl)))
    (message "%s" hl)
    (when (and sch (or (string-equal (org-element-property :type sch) "active-range")
		       (and (string-equal (org-element-property :type closed) "inactive")
			    (org-element-property :year-end closed))))
      ;; instead of creating the entire entry, we create a small one and replace the values
      (message "clocking in and out")
      (org-clock-in)
      (org-clock-out)

      (if (re-search-forward "CLOCK: \\[.+\\]--\\[.+\\]" nil t 1)
	  (format-time-string "[%Y-%m-%d]" (current-time))
	(replace-match (concat
			"CLOCK: "
			(tor/clocks-to-clocked-string
			 (date-to-time (format "%s %02d:%02d"
					       (current-time)
					       ;; (org-element-property :year-start sch)
					       ;; (org-element-property :month-start sch)
					       ;; (org-element-property :day-start sch)
					       (org-element-property :hour-start sch)
					       (org-element-property :minute-start sch)))
			 (date-to-time (format "%s %02d:%02d"
					       (current-time)
					       ;; (org-element-property :year-end sch)
					       ;; (org-element-property :month-end sch)
					       ;; (org-element-property :day-end sch)
					       (org-element-property :hour-end sch)
					       (org-element-property :minute-end sch)))))))
      (org-clock-update-time-maybe)
      (message "%s" sch))))

(defun tor/latex-export-sqlite-blocks (text backend info)
  "Replaces `sqlite' src blocks by `sql' src blocks, as these are handled by minted."
  (when (org-export-derived-backend-p backend 'latex)
    (with-temp-buffer
      (insert text)
      ;; replace verbatim env by listings
      (goto-char (point-min))
      (replace-string "\\begin{minted}[]{sqlite}" "\\begin{minted}[]{sql}")
      (buffer-substring-no-properties (point-min) (point-max)))))

(use-package ob-http)
;; (use-package ob-ipython
;;   :config (progn
;;             (setq ob-ipython-resources-dir "/tmp/obipy-resources/")

;;             ;; HACK: the one below is an improvement
;;             ;; (advice-add 'ob-ipython--collect-json :before
;;             ;; (lambda (&rest args)
;;             ;;   (when (re-search-forward "{" nil t)
;;             ;;     (backward-char))))
;;             (advice-add 'ob-ipython--collect-json :before
;;                         (lambda (&rest args)
;;                           (let ((start (point)))
;;                             (set-mark (point))
;;                             (while (re-search-forward "{" nil t)
;;                               (backward-char)
;;                               (kill-region (region-beginning) (region-end))
;;                               (re-search-forward "}\n" nil t)
;;                               (set-mark (point)))
;;                             (end-of-buffer)
;;                             (kill-region (region-beginning) (region-end))
;;                             (goto-char start))))))
(use-package ob-sql-mode)

(use-package org
  :pin org
  :bind (("C-c l" . org-store-link))
  :init
  (progn
    ;; `sqlite' not available using `minted', so we change those blocks to std `sql' blocks
    (require 'ox)
    (add-to-list 'org-export-filter-src-block-functions 'tor/latex-export-sqlite-blocks)
    (setq org-confirm-babel-evaluate nil
	  org-export-headline-levels 5
	  org-export-with-toc 2
	  org-export-use-babel t ;; necessary for parsing header-arguments of src-blocks

	  org-latex-listings 'minted ;; use `minted' instead of `listings' when exporting to latex

	  org-src-window-setup 'current-window ;; makes it so that the src block is opened in the current window

	  ;; customization for latex-preview in org-mode
	  org-format-latex-options '(:foreground default
						 :background default
						 :scale 1.5
						 :html-foreground "steelblue"
						 :html-background "Transparent"
						 :html-scale 1.0
						 :matchers ("begin" "$1" "$" "$$" "\\(" "\\["))
	  )
    ;; disable execution on export UNLESS otherwise specified
    (add-to-list 'org-babel-default-header-args '(:eval . "never-export")))
  :config
  (progn
    (setq org-confirm-babel-evaluate nil
		  org-export-headline-levels 5
		  org-export-with-toc 2
		  org-export-use-babel t ;; necessary for parsing header-arguments of src-blocks 
	  )
    ;; disable execution on export UNLESS otherwise specified
    (add-to-list 'org-babel-default-header-args '(:eval . "never-export"))

    (global-set-key (kbd "C-c √•") 'org-agenda)
    (global-set-key (kbd "C-c ¬§") 'org-mark-ring-goto)

    ;; https://emacs.stackexchange.com/a/18146
    (require 'bind-key)
    (unbind-key "C-c [" org-mode-map)
    (unbind-key "C-c ," org-mode-map)
    (bind-key "C-c ," 'org-time-stamp-inactive org-mode-map)

    (setcar org-emphasis-regexp-components " \t('\"{[:alpha:]")
    (setcar (nthcdr 1 org-emphasis-regexp-components) "[:alpha:]- \t.,:!?;'\")}\\")
    (org-set-emph-re 'org-emphasis-regexp-components org-emphasis-regexp-components)

    ;; Custom hooks
    (add-hook 'org-mode-hook 'pretty-greek)
    (add-hook 'org-mode-hook 'my-prettiest-symbols)

    ;; Disables flycheck when opening src blocks!
    (defun disable-flycheck-in-org-src-block ()
      (flycheck-mode -1))

    (add-hook 'org-src-mode-hook 'disable-flycheck-in-org-src-block)

    (font-lock-add-keywords 'org-mode
			    '(("^ +\\([-*]\\) "
			       (0 (prog1 () (compose-region (match-beginning 1) (match-end 1) "‚Ä¢"))))))

    ;; org-agenda / org-capture
    (setq org-agenda-files '("~/Dropbox/org/gtd.org"
			     "~/Dropbox/org/school.org"
			     "~/Dropbox/org/reading.org"
			     "~/Dropbox/org/implement.org"))
    (setq org-default-notes-file "~/Dropbox/org/gtd.org")
    (setq org-refile-targets '(("~/Dropbox/org/gtd.org" :maxlevel . 2) 
			       ("~/Dropbox/org/someday.org" :level . 2)))

    (setq org-my-anki-file "~/Dropbox/org/anki.org")

    (setq org-capture-templates
	  '(("t"        ;; shortcut
	     "Todo"     ;; title
	     entry      ;; type of template
	     (file+headline "~/Dropbox/org/gtd.org" "Tasks")  ;; what and where to add
	     "* TODO %^{Brief Description} %^g\nEntered on %U\n%?\n%i\n%a"  ;; template
	     :empty-lines 1 ;; property
	     )

	    ("j" "Journal" entry (file+datetree "~/Dropbox/org/journal.org")
	     "* %^{Description}\nEntered on %U\n%a\n%?" :empty-lines 1)

	    ("i" "Idea" item (file "~/Dropbox/org/ideas.org"))

	    ("s" "School" entry
	     (file "~/Dropbox/org/school.org")
	     "* TODO %^{Brief Description} %^{COURSE}p %^g\n%?" :empty-lines 1)

	    ("r" "Reading" entry (file "~/Dropbox/org/reading.org")
	     "* TODO %(tor/reading-list-next-idx). %?\nEntered on %U\n%a\n%i")

            ("R" "Research" entry (file "~/org-blog/notes/research.org")
	     "* %^{Title} %^g\n:PROPERTIES:\n:DATE: %U\n:SOURCE: %a\n:END:\n%i\n%?")

	    ("I" "Implement" entry (file "~/Dropbox/org/implement.org")
	     "* TODO %(tor/impl-list-next-idx). %?\nEntered on %U\n%a\n%i")

            ;; NOTE: the `ANKI_DECK' property will use auto-completion from `anki-editor.el'
            ;; and thanks to the use of `anki-editor-mode' in `~/Dropbox/org/anki.org'
            ;; we also get autocomplete for the tags.
            ("a" "Anki basic"
             entry
             (file+headline org-my-anki-file "Dispatch Shelf")
             "* %U   %^g\n:PROPERTIES:\n:ANKI_NOTE_TYPE: Basic\n:END:%^{ANKI_DECK}p\n** Front\n%?\n** Back\n%x\n")

            ("A" "Anki cloze"
             entry
             (file+headline org-my-anki-file "Dispatch Shelf")
             "* %U   %^g\n:PROPERTIES:\n:ANKI_NOTE_TYPE: Cloze\n:END:%^{ANKI_DECK}p\n** Text\n%x\n** Extra\n")
            ))
    (setq org-agenda-custom-commands
	  '(("s" alltodo "" ((org-agenda-files '("~/Dropbox/org/school.org"))))
	    ("r" alltodo "" ((org-agenda-files '("~/Dropbox/org/reading.org"))))
	    ("i" alltodo "" ((org-agenda-files '("~/Dropbox/org/implement.org"))))
	    ("p" . "PROJECT+Name tags searches")
	    ("pI" tags "+PROJECT+My")
	    ("po" tags "+PROJECT+Octochain")
	    ("pm" tags "+PROJECT+Masterloop")
	    ("pe" tags "+PROJECT+Easee")
	    ("pp" tags "+PROJECT+Public")))

    ;; babel
    (setq org-babel-clojure-backend 'cider)
    (add-hook 'org-babel-after-execute-hook 'org-babel-python-strip-session-chars)

    ;; Latex
    (require 'ox-latex)
    (add-to-list 'org-latex-packages-alist '("" "listingsutf8"))
    (add-to-list 'org-latex-packages-alist '("" "color"))
    (add-to-list 'org-latex-packages-alist '("" "minted"))

    (add-hook 'org-mode-hook 'visual-line-mode)

    (let ((targetdir "~/.emacs.d/private/ox-jekyll-lite/"))
      (clone-if-not-exists "https://github.com/torfjelde/ox-jekyll-lite.git"
			   targetdir)
      (when (file-directory-p targetdir)
	(add-to-list 'load-path targetdir)))

    ;; HACK: I generally don't use
    (clone-if-not-exists "https://github.com/gjkerns/ob-julia.git"
			 "~/.emacs.d/private/ob-julia/")
    (let ((targetdir "~/.emacs.d/private/ob-julia/"))
      (when (file-directory-p targetdir)
	(add-to-list 'load-path targetdir)))

    ;; if you ever have issues with org-evaluate being disabled
    ;; => https://emacs.stackexchange.com/questions/28441/org-mode-9-unable-to-eval-code-blocks
    (org-babel-do-load-languages
     'org-babel-load-languages
     '((emacs-lisp t)
       (shell . t)
       (C . t)
       (dot . t)
       (latex . t)
       (sql . t)
       (sqlite . t)
       (clojure . t)
       (python . t)
       ;; (R . t)
       ;; (ein . t)
       ;; (ipython . t)
       ;; (scala . t)
       ;; (rust . t)
       ;; (haskell . t)
       (jupyter . t)
       (julia . t)
       ;; (csharp. t)
       (ditaa . t)))

    (setq org-babel-default-header-args:jupyter-julia '((:async . "yes")
							(:session . "jl")
							(:kernel . "julia-1.4")))

    ;; ensure that we use Py3 to evaluate Python blocks
    (setq org-babel-python-command "python3")

    (org-babel-jupyter-override-src-block "julia")
    (org-babel-jupyter-override-src-block "python")

    ;; customization for HTML export using MathJax
    (setq org-html-mathjax-template "<script type=\"text/x-mathjax-config\">
 MathJax.Hub.Config({
   displayAlign: \"%ALIGN\",
   displayIndent: \"%INDENT\",

   \"HTML-CSS\": { scale: %SCALE,
		 linebreaks: { automatic: \"%LINEBREAKS\" },
		 webFont: \"%FONT\"
   },
   SVG: {scale: %SCALE,
	 linebreaks: { automatic: \"%LINEBREAKS\" },
	 font: \"%FONT\"},
   NativeMML: {scale: %SCALE},
   TeX: { equationNumbers: {autoNumber: \"%AUTONUMBER\"},
	  MultLineWidth: \"%MULTLINEWIDTH\",
	  TagSide: \"%TAGSIDE\",
	  TagIndent: \"%TAGINDENT\",
	  extensions: [\"color.js\", \"cancel.js\"]
   },
   extensions: [\"[Contrib]/physics/physics.js\"]
 });
</script>
<script type=\"text/javascript\"
	src=\"%PATH\"></script>

")

    ;; show agenda on startup
    (setq initial-buffer-choice (lambda ()
				  (org-agenda-list)
				  (get-buffer "*Org Agenda*")))

    ;; ox-publish
    (require 'ox-publish)
    (setq org-publish-project-alist
	  '(
	    ;; ... add all the components here (see below)...
	    ("blog-latex"
	     :base-directory "~/org-blog/assets/latex"
	     :publishing-directory "~/org-blog/public_html/assets/latex"
	     :recursive t
	     :publishing-function tor/org-publish-attachment
	     :base-extension "png\\|jpg\\|gif\\\\|ogg\\|swf")

	    ;; ;; TODO: somehow allow us to simply copy the files in one go instead of going through
	    ;; ;; all files to check if modified
	    ("blog-latex-local"
	     :base-directory "~/org-blog/assets/latex"
	     :publishing-directory "~/org-blog/public_html/assets/latex"
	     :recursive nil
	     :preparation-function tor/org-publish-attachment-local
	     :publishing-function identity
	     :base-extension "")

	    ("org-posts"
	     :project-directory "~/org-blog/"
	     :assets-directory "~/org-blog/assets/"
	     :base-directory "~/org-blog/posts/"
	     :base-extension "org"
	     :exclude ".*\\.org_archive|.*\\.org_old"  ;; HACK: this allows us to filter out posts
	     :publishing-directory "~/org-blog/public_html/posts/"
	     :recursive nil
	     :publishing-function tor/org-html-publish-to-html
	     ;; :preparation-function tor/prepare-blog-post-publish
	     :headline-levels 4
	     :auto-preamble t
	     :html-preamble tor/render-html-preamble--posts
	     :html-postamble nil
	     :html-html5-fancy t
	     :html-metadata-timestamp-format "%Y-%m-%d %a")

	    ("org-posts-index"
	     :base-directory "~/org-blog/posts"
	     :base-extension "html"
	     :publishing-directory "~/org-blog/public_html/posts/"
	     :publishing-function tor/publish-html
	     :preparation-function tor/prepare-blog-post-publish
	     :recursive nil
	     :auto-preamble nil
	     :html-postamble nil
	     :html-preamble nil)

	    ("org-posts-assets"
	     :base-directory "~/org-blog/posts/"
	     :base-extension "css\\|js\\|png\\|jpg\\|svg\\|gif\\|mp3\\|ogg\\|swf"
	     :publishing-directory "~/org-blog/public_html/posts/"
	     :recursive t
	     :publishing-function tor/org-publish-attachment)

	    ("org-blog" :components ("org-posts" "org-posts-index" "org-posts-assets"))

	    ("org-notes"
	     :project-directory "~/org-blog/"
	     :assets-directory "ÃÉ~/org-blog/assets/"
	     :base-directory "~/org-blog/notes/"
	     :base-extension "org"
	     :publishing-directory "~/org-blog/public_html/notes/"
	     :recursive t
	     :publishing-function tor/org-html-publish-to-html
	     :headline-levels 4             ; Just the default for this project.
	     :auto-preamble t
	     :html-preamble tor/render-html-preamble
	     :html-postamble nil
	     ;; :html-postamble tor/render-html-postamble
	     ;; :html-html5-fancy t
	     :html-metadata-timestamp-format "%Y-%m-%d %a"
	     )

	    ("org-notes-assets"
	     :base-directory "~/org-blog/notes/"
	     :base-extension "css\\|js\\|png\\|jpg\\|svg\\|gif\\|mp3\\|ogg\\|swf"
	     :publishing-directory "~/org-blog/public_html/notes/"
	     :recursive t
	     :publishing-function tor/org-publish-attachment)

	    ("org-static"
	     :project-directory "~/org-blog/"
	     :base-directory "~/org-blog/assets/"
	     ;; :base-extension "css\\|js\\|png\\|jpg\\|gif\\|mp3\\|ogg\\|swf"
	     :base-extension "css\\|js\\|gif\\|mp3\\|ogg\\|swf"
	     :publishing-directory "~/org-blog/public_html/assets/"
	     :recursive t
	     :publishing-function tor/org-publish-attachment)

	    ("org"
	     :components ("org-notes" "org-notes-assets" "org-static"))

	    ("org-papers"
	     ;; :base-directory "~/Dropbox/bibliography/notes/"
	     :project-directory "~/org-blog/"
	     :assets-directory "ÃÉ~/org-blog/assets/"
	     :base-directory "~/org-blog/papers/"
	     :base-extension "org"
	     :publishing-directory "~/org-blog/public_html/papers/"
	     :recursive nil
	     :publishing-function tor/org-html-publish-to-html
	     :headline-levels 4
	     :auto-premable t
	     :html-postamble nil)
	    ))
    ))

(use-package org-bullets
  :init (add-hook 'org-mode-hook 'org-bullets-mode))

;; This adds some autocomplete stuff specific for Org-mode, e.g. allowing you to
;; add multiple tags to a headline using autocompletion.
(use-package helm-org
  :pin melpa
  :init (progn
          ;; ensures that it works correctly with org-capture
          (add-to-list 'helm-completing-read-handlers-alist '(org-capture . helm-org-completing-read-tags))
          (add-to-list 'helm-completing-read-handlers-alist '(org-set-tags . helm-org-completing-read-tags))))

(defun tor/org-ref-open-bibtex-pdf ()
  "Attemt to open PDF from file-field in BibTeX entry if does not exist in default pdf-dir."
  (interactive)
  (save-excursion
    (bibtex-beginning-of-entry)
    (let* ((bibtex-expand-strings t)
	   (entry (bibtex-parse-entry t))
	   (key (reftex-get-bib-field "=key=" entry))
	   (pdf (org-ref-get-mendeley-filename key)))
      (message "%s" pdf)
      (if (file-exists-p pdf)
	  (org-open-link-from-string (format "[[file:%s]]" pdf))
	(ding)))))

;; TODO: is this necessary?
(use-package bibtex-completion
  :pin melpa)

(use-package helm-bibtex
  :pin melpa
  :config (require 'bibtex-completion))

;; (use-package org-ref
;;   :pin melpa
;;   :config (progn
;; 	    (setq reftex-default-bibliography '("~/Dropbox/bibliography/references.bib")
;; 		  org-ref-bibliography-notes "~/Dropbox/bibliography/notes.org"
;; 		  org-ref-default-bibliography '("~/Dropbox/bibliography/references.bib")
;; 		  org-ref-pdf-directory "~/Dropbox/bibliography/pdfs/"
;; 		  biblio-download-directory "~/Dropbox/bibliography/pdfs/"
;; 		  bibtex-completion-bibliography '("~/Dropbox/bibliography/references.bib")
;; 		  ;; bibtex-completion-notes-path "/home/tor/Dropbox/bibliography/notes/"
;; 		  bibtex-completion-notes-path "/home/tor/org-blog/papers/"
;; 		  bibtex-completion-notes-template-multiple-files "#+SETUPFILE: ../setup-level-1.org\n#+TITLE: Notes on: ${author-or-editor} (${year}): ${title}\n\n"

;; 		  bibtex-completion-library-path '("~/Dropbox/bibliography/pdfs")

;; 		  ;; ensures that the use of #+NAME: works properly when exporting
;; 		  org-latex-prefer-user-labels t

;; 		  ;; with this activated it's horrendously SLOW for large files
;; 		  org-ref-show-broken-links nil

;; 		  org-latex-pdf-process '("pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"
;; 					  "bibtex %b"
;; 					  "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"
;; 					  "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f")
;; 		  ;; also attempts to open what's referenced in the "file = ..." field of the BibTeX entry
;; 		  org-ref-open-pdf-function 'tor/org-ref-open-bibtex-pdf

;; 		  ;; adds more entry-types, e.g. @misc and @online
;; 		  ;; bibtex-dialect 'biblatex
;; 		  )))
(use-package org-ref
  :pin melpa
  :config (progn
            (setq reftex-default-bibliography '("~/Dropbox/bibliography/references.bib")
                  org-ref-bibliography-notes "~/Dropbox/bibliography/notes.org"
                  org-ref-default-bibliography '("~/Dropbox/bibliography/references.bib")
                  org-ref-pdf-directory "~/Dropbox/bibliography/pdfs/"
                  biblio-download-directory "~/Dropbox/bibliography/pdfs/"
                  bibtex-completion-bibliography '("~/Dropbox/bibliography/references.bib")
                  ;; bibtex-completion-notes-path "/home/tor/Dropbox/bibliography/notes/"
                  bibtex-completion-notes-path "/home/tor/org-blog/papers/"
                  bibtex-completion-notes-template-multiple-files "#+SETUPFILE: ../setup-level-1.org\n#+TITLE: Notes on: ${author-or-editor} (${year}): ${title}\n\n"

                  bibtex-completion-library-path '("~/Dropbox/bibliography/pdfs")

                  ;; ensures that the use of #+NAME: works properly when exporting
                  org-latex-prefer-user-labels t

                  ;; with this activated it's horrendously SLOW for large files
                  org-ref-show-broken-links nil

                  org-latex-pdf-process '("pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"
                                          "bibtex %b"
                                          "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"
                                          "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f")
                  ;; also attempts to open what's referenced in the "file = ..." field of the BibTeX entry
                  org-ref-open-pdf-function 'tor/org-ref-open-bibtex-pdf

                  ;; adds more entry-types, e.g. @misc and @online
                  ;; bibtex-dialect 'biblatex
                  )

            ;; overwrites the 'inbook' BibTeX type defined by doi-utils
            ;; +FIXME+: getting an issue with "mandatory field is missing: chapter"
            ;; the above was due to the choice of dialect
            (doi-utils-def-bibtex-type book ("book")
                                       author title booktitle series publisher year pages doi url)
            (doi-utils-def-bibtex-type inbook ("book-chapter" "chapter" "reference-entry")
                                       author title booktitle series publisher year pages doi url)
            ;;

            ;; FIXME: for now we make `misc' a placeholder for `online'
            ;; since the dialect `BibTeX' does not support `online'
            ;; which causes issues when exporting Org-files

            ;; (doi-utils-def-bibtex-type online ("online")
            ;;                            author title url year)
            ;; (add-to-list 'org-ref-bibliography-entry-format '("online" . "%a, %t, <a href=\"%U\">link</a>. %N"))
            ;; and misc

            (add-to-list 'org-ref-bibliography-entry-format '("misc" . "%a, %t, <a href=\"%U\">link</a>.. %N"))

            ;; NOT WORKING
            ;; (defun my-pdf-proxy (orig-fun &rest args)
            ;;   (let* ((pdf-url (apply orig-fun args))
            ;;          (url-struct (url-generic-parse-url pdf-url)))
            ;;     (setf (url-host url-struct)
            ;;           (concat (url-host url-struct) ".ezproxy.is.ed.ac.uk"))
            ;;     (url-recreate-url url-struct)))

            ;; remove it like this.
            ;; (advice-remove 'doi-utils-get-pdf-url #'my-pdf-proxy)
            ;; (advice-add 'doi-utils-get-pdf-url :around #'my-pdf-proxy)
            (bind-key "C-c ]" 'org-ref-helm-insert-cite-link)
            )
  :init (progn
          (require 'org-ref-pdf)
          (bind-key "C-c [" 'org-ref-insert-ref-link)
          (bind-key "C-c ]" 'org-ref-helm-insert-cite-link)))
#+end_src

**** Additional stuff
- To make it so what we open PDFs using =pdftools= rather than the default viewer on the system, one needs to change =org-file-apps= , in particular the =\\.pdf\\= field. E.g. =(add-to-list 'org-file-apps '("\\.pdf\\'" . emacs))=
- When generating PDF from Org-files (though LaTeX), the process might fail due to =hyerref= messing up. If so, check the generated =.tex= file to see if you have two inclusions of =hyperref=, and if you do, change =org-latex-default-packages-alist=.
  - This is because you have an additional configuration for =hyperref= somewhere in the config file.

*** =org-download=
=org-download= allows you to do neat stuff like drag-and-drop images into an org-buffer to insert the image there!

#+name: el-pkg-org-download
#+begin_src emacs-lisp 
(use-package org-download
  :config (progn
          ;; don't want to use the sub-headings for the folder name
          ;; TODO: check if this actually work! Might be buffer-local, hence not do anything.
          (setq org-download-heading-lvl nil)
          
          ;; HACK: overload this method so we fall back to using "./.filename/assets/" for the downloaded stuff
          (defun org-download--dir-1 ()
            (or org-download-image-dir (concat (file-name-as-directory ".") "." (file-name-base) "/attachments")))))
#+end_src

*** =org-pdftools=
This allows you to reference specific text and stuch in a PDF-document!

#+name: el-pkg-org-pdftools
#+begin_src emacs-lisp 
(use-package org-pdftools
  :after org
  :config (org-pdftools-setup-link))
#+end_src

*** =org-noter= & =org-noter-pdftools=
#+name: el-pkg-org-noter
#+begin_src emacs-lisp 
(use-package org-noter
  :config
  ;; Your org-noter config ........
  (require 'org-noter-pdftools))

(use-package org-pdftools
  :hook (org-mode . org-pdftools-setup-link))

(use-package org-noter-pdftools
  :after org-noter
  :config
  ;; Add a function to ensure precise note is inserted
  (defun org-noter-pdftools-insert-precise-note (&optional toggle-no-questions)
    (interactive "P")
    (org-noter--with-valid-session
     (let ((org-noter-insert-note-no-questions (if toggle-no-questions
                                                   (not org-noter-insert-note-no-questions)
                                                 org-noter-insert-note-no-questions))
           (org-pdftools-use-isearch-link t)
           (org-pdftools-use-freestyle-annot t))
       (org-noter-insert-note (org-noter--get-precise-info)))))

;;   ;; fix https://github.com/weirdNox/org-noter/pull/93/commits/f8349ae7575e599f375de1be6be2d0d5de4e6cbf
;;   (defun org-noter-set-start-location (&optional arg)
;;     "When opening a session with this document, go to the current location.
;; With a prefix ARG, remove start location."
;;     (interactive "P")
;;     (org-noter--with-valid-session
;;      (let ((inhibit-read-only t)
;;            (ast (org-noter--parse-root))
;;            (location (org-noter--doc-approx-location (when (called-interactively-p 'any) 'interactive))))
;;        (with-current-buffer (org-noter--session-notes-buffer session)
;;          (org-with-wide-buffer
;;           (goto-char (org-element-property :begin ast))
;;           (if arg
;;               (org-entry-delete nil org-noter-property-note-location)
;;             (org-entry-put nil org-noter-property-note-location
;;                            (org-noter--pretty-print-location location))))))))

  (with-eval-after-load 'pdf-annot
    (add-hook 'pdf-annot-activate-handler-functions #'org-noter-pdftools-jump-to-note)))
#+end_src

*** =org-pomodoro=
#+name: el-pkg-org-pomodoro
#+begin_src emacs-lisp 
(use-package org-pomodoro
  :pin melpa
  :ensure t
  :commands (org-pomodoro)
  :config
  (progn
    (setq alert-user-configuration (quote ((((:category . "org-pomodoro")) libnotify nil))))
    (setq org-pomodoro-length 60) ;; make one session 1hr
    ))
#+end_src

**** =libnotify= might not be available
=libnotify= is used to make a desktop notification rather than /just/ a "message" in Emacs. This is super-dope! But, depending on which distribution you're on (only works for Linux), =libnotify= might not be available. If so you possible have to run

#+begin_src sh :eval no
sudo apt-get install libnotify-bin
#+end_src

*** =which-key=
#+name: el-pkg-which-key
#+begin_src emacs-lisp 
(use-package which-key
  :pin melpa
  :config (which-key-mode))
#+end_src

*** =polymode=
#+name: el-pkg-polymode
#+begin_src emacs-lisp 
(use-package polymode)
(use-package poly-markdown
  :mode ("\\.[jJ]md" . poly-markdown-mode)
  :bind (:map poly-markdown-mode-map
              ("C-c '" . markdown-edit-code-block)))
#+end_src

**** Concepts
- *span* is a contiugous and homogenous region of text of the /same/ major mode. There are 4 different types:
  1. Head
  2. Body
  3. Tail
  4. Host
- *chunk* is a contiguous region that consists of one or more /spans/.
  - There are two major types:
    1. *host chunk* which contain only /one/ span in the /host/ major mode
    2. *inner chunk* which consists of head, body and tail, where /body/ is of some other mode than host.
  - Naming: =pm-XYZ-hostmode= and =pm-XYZ-innermode=
- *Polymode*:
  - Means one of the following:
    1. a /sum/ of related functionality available in buffers
    2. /function/ which installs a bunch of functioanlity into emacs buffers
    3. an /object/ of class =pm-polymode= which holds the configuration for the polymode
  - Naming: =polymode-XYZ-mode=
  - Major and minor mode design:
    - Most polymodes are designed to be used as major modes (i.e. in =auto-mode-alist= or buffer-local =mode:= cookie)
    - Some polymodes (those with host's =:mode= slot set to =nil=) are explicitly designed to be used as minor modes.
- *chunkmode* and the more specific *hostmode* and *innermode* mean either:
  1. a /sum/ of related functionality in host and inner chunks
  2. configuration /objects/ derived from =pm-chunkmode= class (i.e. =pm-host-hostmode=, =pm-inner-innermode=, =pm-inner-auto-chunkmode=)


#+DOWNLOADED: file:///home/tor/Pictures/Selection_064.png @ 2020-09-24 21:52:51
[[file:.config/attachments/=init.el=/Selection_064_2020-09-24_21-52-51.png]]

*** =treemacs=
#+name: el-pkg-treemacs
#+begin_src emacs-lisp 
(use-package treemacs
  :pin melpa
  :bind (("M-0" . treemacs-select-window)))

(use-package treemacs-projectile
  :pin melpa)
#+end_src

*** =default-text-scale=
#+name: el-pkg-default-text-scale
#+begin_src emacs-lisp 
(define-minor-mode big-font-mode
  "A global mode that resizes the font, for streams, screen-sharing and
presentations.
This uses `default-text-scale-increment' under the hood, and enlargens the font by 100."
  :init-value nil
  :lighter " BIG"
  :global t
  (progn
    (require 'default-text-scale)
    (if big-font-mode
        (default-text-scale-reset)
        (default-text-scale-increment 100))))
#+end_src

*** Emacs anywhere
#+name: el-pkg-emacs-anywhere
#+begin_src emacs-lisp 
(defun github-conversation-p (app-name window-title)
  (and
   (string-match-p "google-chrome" (downcase app-name))
   (or (string-match-p "Pull Request" window-title)
       (string-match-p "Issue" window-title))))

(defun plutojl-p (app-name window-title)
  (and
   (string-match-p "google-chrome" (downcase app-name))
   ;; Last part of the window name should be `Pluto.jl'
   (string-match-p "Pluto\\.jl$" window-title)))

(defun popup-handler (app-name window-title x y w h)
  ;; Resize
  (set-frame-width (selected-frame) 250)
  (set-frame-height (selected-frame) 50)
  ;; set major mode
  (cond
   ((github-conversation-p app-name window-title) (poly-markdown-mode))
   ((plutojl-p app-name window-title) (julia-mode))
   ;; ...
   (t (poly-markdown-mode)) ; default major mode
   ))

;; Hook your function
(add-hook 'ea-popup-hook 'popup-handler)
#+end_src

** Theming
#+name: el-theme
#+begin_src emacs-lisp 
;;; themes ;;;
(message "Parsing themes")
(use-package solarized-theme
  :init (progn
          ;; Sets it to similar colors as the theme-colors; if `t' we use `dark' else we use `light'.
          ;; `solarized-dark' will have the "correct" midnight mode, so only do it if using `light'.
          (when nil
            ;; (setq pdf-view-midnight-colors '("#556065" . "#fdf6e3"))
            ;; (setq pdf-view-midnight-colors '("#3f4446" . "#fdf6e3")) ;; slightly blacker font
            (setq pdf-view-midnight-colors '("#556065" . "#fff8e5")) ;; slightly brighter background
            )))

;; (use-package darktooth-theme)
;; (use-package atom-one-dark-theme)
;; :init
;; (add-hook 'after-make-frame-functions
;;         '(lambda (frame)
;;           (select-frame frame)
;;           (if window-system
;;               nil
;; 	      (set-frame-parameter nil 'background-color "#2B2B2B")
;; 	      ))))

;; Essentially removing the background color in terminal since I often use transparent terminals
(defun on-frame-open (&optional frame)
  "If the FRAME created in terminal don't load background color."
  (unless (display-graphic-p frame)
    (set-face-background 'default "unspecified-bg" frame)))

(add-hook 'after-make-frame-functions 'on-frame-open)

;; (custom-set-variables '(custom-enabled-themes (quote solarized-dark))
#+end_src

** Line
#+name: el-line
#+begin_src emacs-lisp 
(use-package smart-mode-line)
(use-package spaceline
  :init
  (progn
	(require 'spaceline-config)
	(spaceline-emacs-theme)
        ))
#+end_src

** Disabling some default stuff
#+name: el-final-setup
#+begin_src emacs-lisp 
(blink-cursor-mode -1)
(tool-bar-mode -1)
(menu-bar-mode -1)
(scroll-bar-mode -1)
#+end_src
** Final
#+begin_src emacs-lisp :noweb yes :tangle no
<<el-global-variables>>

<<el-sympy>>

<<el-util>>

<<el-time-format-advice>>

;; PEP-8 tells me not to use tabs..so by defalt we disable this
(setq-default indent-tabs-mode nil)


;;; Custom functions for note-taking ;;;
(defun notes:code-directory ()
    (let* ((filepath (buffer-file-name))
	   (directory (file-name-directory filepath))
	   (filebase (file-name-base filepath)))
      (concat
       directory
       (file-name-as-directory (concat "." filebase))
       (file-name-as-directory "code"))))

(defun notes:code-file-path (filename)
  (let ((code-dir (notes:code-directory)))
    (concat code-dir filename)))


<<el-pretty>>

;; convience functions
(defun my/open-block-c-mode (id action context)
  (when (eq action 'insert)
	(newline)
	(indent-according-to-mode)
	(previous-line)
	(indent-according-to-mode)))

(defun my/duplicate-line ()
  "Copies current line to next line. Like C-d in Pycharm"
  (interactive)
  (move-beginning-of-line 1)
  (kill-line)
  (yank)
  (open-line 1)
  (next-line)
  (yank))

(defun org-babel-python-strip-session-chars ()
  "Remove >>> and ... from a Python session output."
  (when (and (string=
	      "python"
	      (org-element-property :language (org-element-at-point)))
	     (string-match
	      ":session"
	      (org-element-property :parameters (org-element-at-point))))
    (save-excursion
      (when (org-babel-where-is-src-block-result)
	(goto-char (org-babel-where-is-src-block-result))
	(end-of-line 1)
	;(while (looking-at "[\n\r\t\f ]") (forward-char 1))
	(while (re-search-forward
		"\\(>>> \\|\\.\\.\\. \\|: $\\|: >>>$\\)"
		(org-element-property :end (org-element-at-point))
		t)
	  (replace-match "")
	  ;; this enables us to get rid of blank lines and blank : >>>
	  (beginning-of-line)
	  (when (looking-at "^$")
	    (kill-line)))))))

;; global keys
(global-set-key (kbd "C-c c") 'org-capture)
(global-set-key (kbd "C-c C-d") 'my/duplicate-line)
;; (global-set-key (kbd "C-;") 'iedit-mode)

<<el-package-manager-setup>>

<<el-os-specific>>

;;; xclip

<<el-pkg-pdf-tools>>

<<el-pkg-vterm>>

;; PACKAGES
<<el-pkg-auctex>>

<<el-pkg-anki-editor>>

<<el-pkg-flycheck>>

<<el-pkg-company>>

<<el-pkg-yasnippet>>

<<el-pkg-undo-tree>>

<<el-pkg-smartparens>>

<<el-pkg-edit-server>>

<<el-pkg-visual-fill-column>>

<<el-pkg-which-key>>

<<el-pkg-polymode>>

;; helm
<<el-pkg-helm>>

<<el-pkg-helm-descbinds>>

;; Project stuff
<<el-pkg-projectile>>

(use-package helm-projectile)

<<el-pkg-magit>>

<<el-pkg-forge>>


;; Navigation

;; dirtree
(use-package dirtree)

<<el-pkg-avy>>

<<el-pkg-ace-window>>

;; Editing
<<el-pkg-multiple-cursors>>

<<el-pkg-iedit>>

;; Visual
(use-package rainbow-delimiters)
(use-package centered-cursor-mode)
(use-package htmlize)

(use-package default-text-scale
  :pin melpa
  :bind (("C-M-=" . default-text-scale-increase)
         ("C-M--" . default-text-scale-decrease))
  )

<<el-pkg-default-text-scale>>


(message "Parsing programming setup")


;;; programming languages ;;;
<<el-pkg-fic-mode>>

<<el-prog-general>>

<<el-prog-c-and-cplusplus>>

<<el-prog-arduino>>

<<el-prog-lisp>>

;; https://github.com/magnars/dash.el
(use-package dash
  :pin melpa)

(use-package helpful
  :pin melpa-stable)

<<el-prog-clojure>>

<<el-prog-rust>>

<<el-prog-scala>>

<<el-prog-groovy>>

<<el-prog-csharp>>

<<el-prog-golang>>

<<el-prog-jupyter>>

<<el-prog-julia>>

<<el-prog-web>>

<<el-prog-markdown>>

<<el-prog-R>>

<<el-prog-python>>

<<el-prog-haskell>>

<<el-prog-lua>>


;; XAML stuff
(add-hook 'nxml-mode-hook 'turn-on-smartparens-mode)
(add-hook 'nxml-mode-hook 'show-paren-mode)

;; YAML
(use-package yaml-mode
  :pin melpa-stable
  :mode "\\.yaml\\'")

;; cassandra CQL
(use-package cql-mode
  :mode "\\.cql?$")


(add-hook 'lisp-mode-hook 'pretty-greek)
(add-hook 'emacs-lisp-mode-hook 'pretty-greek)

;; END programming

<<el-org-mode>>

<<el-pkg-org-noter>>

<<el-pkg-org-download>>

<<el-pkg-org-pdftools>>

<<el-pkg-org-pomodoro>>

;; END org-mode

<<el-theme>>

<<el-line>>

;; (let* ((variable-tuple (cond ((x-list-fonts "Source Sans Pro") '(:font "Source Sans Pro"))
;;                              ((x-list-fonts "Lucida Grande")   '(:font "Lucida Grande"))
;;                              ((x-list-fonts "Verdana")         '(:font "Verdana"))
;;                              ((x-family-fonts "Sans Serif")    '(:family "Sans Serif"))
;;                              (nil (warn "Cannot find a Sans Serif Font.  Install Source Sans Pro."))))
;;        (base-font-color     (face-foreground 'default nil 'default))
;;        (headline           `(:inherit default :weight bold :foreground ,base-font-color)))

;; 	  ;; some settings for makin headings and bullets nicer
;; 	  (custom-theme-set-faces 'user
;; 							  `(org-level-8 ((t (,@headline ,@variable-tuple))))
;; 							  `(org-level-7 ((t (,@headline ,@variable-tuple))))
;; 							  `(org-level-6 ((t (,@headline ,@variable-tuple))))
;; 							  `(org-level-5 ((t (,@headline ,@variable-tuple))))
;; 							  `(org-level-4 ((t (,@headline ,@variable-tuple :height 1.1))))
;; 							  `(org-level-3 ((t (,@headline ,@variable-tuple :height 1.25))))
;; 							  `(org-level-2 ((t (,@headline ,@variable-tuple :height 1.5))))
;; 							  `(org-level-1 ((t (,@headline ,@variable-tuple :height 1.75))))
;; 							  `(org-document-title ((t (,@headline ,@variable-tuple :height 1.5 :underline nil))))))

;; Global keybindings
(bind-keys*
 ("C-x C-y" . tor/duplicate-downward)
 ("C-c C-x C-m" . mc/mark-all-in-region))

;; add the private files to `load-path'
(message "Loading private files")
(add-to-list 'load-path "~/.emacs.d/private/")
(load "utilities")
(require 'bookmark+)

;; TODO: make this automatically download and set it up
;; Requires downloading and loading https://github.com/emacsmirror/emacswiki.org/blob/master/header2.el
;; and then the following can be used to automatically insert headers!
;; (defsubst header-org-mode-latex-default ()
;;   (when (eq major-mode 'org-mode)
;;     (insert "#+SETUPFILE: ~/org-blog/setup.org\n")))

;; (setq make-header-hook '(header-org-mode-latex-default))

;; (add-hook 'org-mode-hook 'auto-make-header)

<<el-final-setup>>

<<el-global-variables-final>>

(message "Parsing custom-variables")

;; (custom-set-variables
;;  '(custom-enabled-themes (quote (solarized-dark)))
;;  '(custom-safe-themes
;;    (quote
;;     ("a27c00821ccfd5a78b01e4f35dc056706dd9ede09a8b90c6955ae6a390eb1c1e" "c74e83f8aa4c78a121b52146eadb792c9facc5b1f02c917e3dbb454fca931223" "2809bcb77ad21312897b541134981282dc455ccd7c14d74cc333b6e549b824f3" "13a8eaddb003fd0d561096e11e1a91b029d3c9d64554f8e897b2513dbf14b277" "830877f4aab227556548dc0a28bf395d0abe0e3a0ab95455731c9ea5ab5fe4e1" "7f1d414afda803f3244c6fb4c2c64bea44dac040ed3731ec9d75275b9e831fe5" "669e02142a56f63861288cc585bee81643ded48a19e36bfdf02b66d745bcc626" "a8245b7cc985a0610d71f9852e9f2767ad1b852c2bdea6f4aadc12cce9c4d6d0" "d91ef4e714f05fff2070da7ca452980999f5361209e679ee988e3c432df24347" "0598c6a29e13e7112cfbc2f523e31927ab7dce56ebb2016b567e1eff6dc1fd4f" "ec5f761d75345d1cf96d744c50cf7c928959f075acf3f2631742d5c9fe2153ad" "59171e7f5270c0f8c28721bb96ae56d35f38a0d86da35eab4001aebbd99271a8" "3c83b3676d796422704082049fc38b6966bcad960f896669dfc21a7a37a748fa" default)))
;;  '(default-text-scale-mode t nil (default-text-scale))
;;  )
'
;; (custom-set-variables
;;  ;; custom-set-variables was added by Custom.
;;  ;; If you edit it by hand, you could mess it up, so be careful.
;;  ;; Your init file should contain only one such instance.
;;  ;; If there is more than one, they won't work right.
;;  '(TeX-view-program-selection
;;    (quote
;;     (((output-dvi has-no-display-manager)
;;       "dvi2tty")
;;      ((output-dvi style-pstricks)
;;       "dvips and gv")
;;      (output-dvi "xdvi")
;;      (output-pdf "PDF Tools")
;;      (output-html "xdg-open"))))
;;  '(bibtex-completion-pdf-field "file")
;;  '(blink-cursor-mode nil)
;;  '(bmkp-last-as-first-bookmark-file "~/.emacs.d/bookmarks")
;;  '(compilation-message-face (quote default))
;;  '(custom-enabled-themes (quote (solarized-dark)))
;;  '(custom-safe-themes
;;    (quote
;;     ("a27c00821ccfd5a78b01e4f35dc056706dd9ede09a8b90c6955ae6a390eb1c1e" "c74e83f8aa4c78a121b52146eadb792c9facc5b1f02c917e3dbb454fca931223" "2809bcb77ad21312897b541134981282dc455ccd7c14d74cc333b6e549b824f3" "13a8eaddb003fd0d561096e11e1a91b029d3c9d64554f8e897b2513dbf14b277" "830877f4aab227556548dc0a28bf395d0abe0e3a0ab95455731c9ea5ab5fe4e1" "7f1d414afda803f3244c6fb4c2c64bea44dac040ed3731ec9d75275b9e831fe5" "669e02142a56f63861288cc585bee81643ded48a19e36bfdf02b66d745bcc626" "a8245b7cc985a0610d71f9852e9f2767ad1b852c2bdea6f4aadc12cce9c4d6d0" "d91ef4e714f05fff2070da7ca452980999f5361209e679ee988e3c432df24347" "0598c6a29e13e7112cfbc2f523e31927ab7dce56ebb2016b567e1eff6dc1fd4f" "ec5f761d75345d1cf96d744c50cf7c928959f075acf3f2631742d5c9fe2153ad" "59171e7f5270c0f8c28721bb96ae56d35f38a0d86da35eab4001aebbd99271a8" "3c83b3676d796422704082049fc38b6966bcad960f896669dfc21a7a37a748fa" default)))
;;  '(default-text-scale-mode t nil (default-text-scale))
;;  '(elpy-rpc-python-command "python3")
;;  '(julia-max-block-lookback 100000)
;;  '(magit-diff-use-overlays nil)
;;  '(markdown-command "/usr/bin/pandoc")
;;  '(org-agenda-files
;;    (quote
;;     ("~/Dropbox/org/gtd.org" "~/Dropbox/org/school.org" "~/Dropbox/org/reading.org" "~/Dropbox/org/implement.org")))
;;  '(org-babel-inline-result-wrap "%s")
;;  '(org-edit-src-content-indentation 0)
;;  '(org-emphasis-alist
;;    (quote
;;     (("*" bold)
;;      ("/" italic)
;;      ("_" default)
;;      ("=" org-verbatim verbatim)
;;      ("~" org-code verbatim)
;;      ("+"
;;       (:strike-through t)))))
;;  '(org-format-latex-header
;;    "\\documentclass{article}
;; \\usepackage[usenames]{color}
;; [PACKAGES]
;; [DEFAULT-PACKAGES]
;; \\pagestyle{empty}             % do not remove
;; % The settings below are copied from fullpage.sty
;; \\setlength{\\textwidth}{\\paperwidth}
;; \\addtolength{\\textwidth}{-3cm}
;; \\setlength{\\oddsidemargin}{1.5cm}
;; \\addtolength{\\oddsidemargin}{-2.54cm}
;; \\setlength{\\evensidemargin}{\\oddsidemargin}
;; \\setlength{\\textheight}{\\paperheight}
;; \\addtolength{\\textheight}{-\\headheight}
;; \\addtolength{\\textheight}{-\\headsep}
;; \\addtolength{\\textheight}{-\\footskip}
;; \\addtolength{\\textheight}{-3cm}
;; \\setlength{\\topmargin}{1.5cm}
;; \\addtolength{\\topmargin}{-2.54cm}")
;;  '(org-format-latex-options
;;    (quote
;;     (:foreground default :background default :scale 1.5 :html-foreground "SteelBlue" :html-background "Transparent" :html-scale 1.0 :matchers
;;                  ("begin" "$1" "$" "$$" "\\(" "\\["))))
;;  '(org-html-htmlize-output-type (quote inline-css))
;;  '(org-html-mathjax-options
;;    (quote
;;     ((path "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML")
;;      (scale "100")
;;      (align "center")
;;      (font "Neo-Euler")
;;      (linebreaks "false")
;;      (autonumber "AMS")
;;      (indent "0em")
;;      (multlinewidth "85%")
;;      (tagindent ".8em")
;;      (tagside "right"))))
;;  '(org-latex-default-packages-alist
;;    (quote
;;     (("AUTO" "inputenc" t
;;       ("pdflatex"))
;;      ("T1" "fontenc" t
;;       ("pdflatex"))
;;      ("" "graphicx" t nil)
;;      ("" "grffile" t nil)
;;      ("" "longtable" nil nil)
;;      ("" "wrapfig" nil nil)
;;      ("" "rotating" nil nil)
;;      ("normalem" "ulem" t nil)
;;      ("" "amsmath" t nil)
;;      ("" "textcomp" t nil)
;;      ("" "amssymb" t nil)
;;      ("" "capt-of" nil nil))))
;;  '(org-latex-hyperref-template "
;; ")
;;  '(org-latex-pdf-process
;;    (quote
;;     ("pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f" "bibtex %b" "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f" "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f")))
;;  '(org-link-file-path-type (quote relative))
;;  '(org-preview-latex-image-directory "/home/tor/.ltximg/")
;;  '(org-preview-latex-process-alist
;;    (quote
;;     ((dvipng :programs
;;              ("latex" "dvipng")
;;              :description "dvi > png" :message "you need to install the programs: latex and dvipng." :image-input-type "dvi" :image-output-type "png" :image-size-adjust
;;              (1.0 . 1.0)
;;              :latex-compiler
;;              ("latex -interaction nonstopmode -output-directory %o %f")
;;              :image-converter
;;              ("dvipng -D %D -T tight -o %O %f"))
;;      (dvisvgm :programs
;;               ("latex" "dvisvgm")
;;               :description "dvi > svg" :message "you need to install the programs: latex and dvisvgm." :use-xcolor t :image-input-type "dvi" :image-output-type "svg" :image-size-adjust
;;               (1.7 . 1.5)
;;               :latex-compiler
;;               ("latex -interaction nonstopmode -output-directory %o %f")
;;               :image-converter
;;               ("dvisvgm %f -n -b min -c %S -o %O"))
;;      (imagemagick :programs
;;                   ("latex" "convert")
;;                   :description "pdf > png" :message "you need to install the programs: latex and imagemagick." :use-xcolor t :image-input-type "pdf" :image-output-type "png" :image-size-adjust
;;                   (1.0 . 1.0)
;;                   :latex-compiler
;;                   ("pdflatex -interaction nonstopmode -output-directory %o %f")
;;                   :image-converter
;;                   ("convert -density %D -trim -antialias %f -quality 100 -transparent white %O")))))
;;  '(org-ref-bib-html "")
;;  '(org-ref-formatted-citation-formats
;;    (quote
;;     (("text"
;;       ("article" . "${author}, ${title}, ${journal}, ${archivePrefix}:${eprint} [${primaryClass}], ${volume}(${number}), ${pages} (${year}). ${doi}")
;;       ("inproceedings" . "${author}, ${title}, In ${editor}, ${booktitle} (pp. ${pages}) (${year}). ${address}: ${publisher}.")
;;       ("book" . "${author}, ${title} (${year}), ${address}: ${publisher}.")
;;       ("phdthesis" . "${author}, ${title} (Doctoral dissertation) (${year}). ${school}, ${address}.")
;;       ("inbook" . "${author}, ${title}, In ${editor} (Eds.), ${booktitle} (pp. ${pages}) (${year}). ${address}: ${publisher}.")
;;       ("incollection" . "${author}, ${title}, In ${editor} (Eds.), ${booktitle} (pp. ${pages}) (${year}). ${address}: ${publisher}.")
;;       ("proceedings" . "${editor} (Eds.), ${booktitle} (${year}). ${address}: ${publisher}.")
;;       ("unpublished" . "${author}, ${title} (${year}). Unpublished manuscript.")
;;       (nil . "${author}, ${title} (${year})."))
;;      ("org"
;;       ("article" . "${author}, /${title}/, ${journal}, *${volume}(${number})*, ${pages} (${year}). ${doi}")
;;       ("inproceedings" . "${author}, /${title}/, In ${editor}, ${booktitle} (pp. ${pages}) (${year}). ${address}: ${publisher}.")
;;       ("book" . "${author}, /${title}/ (${year}), ${address}: ${publisher}.")
;;       ("phdthesis" . "${author}, /${title}/ (Doctoral dissertation) (${year}). ${school}, ${address}.")
;;       ("inbook" . "${author}, /${title}/, In ${editor} (Eds.), ${booktitle} (pp. ${pages}) (${year}). ${address}: ${publisher}.")
;;       ("incollection" . "${author}, /${title}/, In ${editor} (Eds.), ${booktitle} (pp. ${pages}) (${year}). ${address}: ${publisher}.")
;;       ("proceedings" . "${editor} (Eds.), _${booktitle}_ (${year}). ${address}: ${publisher}.")
;;       ("unpublished" . "${author}, /${title}/ (${year}). Unpublished manuscript.")
;;       (nil . "${author}, /${title}/ (${year}).")))))
;;  '(org-reveal-mathjax-url "./MathJax-2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML")
;;  '(package-selected-packages
;;    (quote
;;     (solarized-theme ox-jekyll-md stan-mode pdf-tools helm-bibtex gnuplot org-tree-slide gnu-elpa-keyring-update annotate jupyter lv sudo-edit ox-gfm graphviz-dot-mode ox-reveal projectile-ripgrep sublimity gif-screencast ox-rst interleave xah-lookup org-brain web-mode use-package string-inflection spotify spaceline smartparens smart-mode-line racer ox-hugo ox-clip owdriver org-ref org-clock-convenience org-bullets ob-sql-mode ob-rust ob-http ob-go mustache multiple-cursors matlab-mode irony-eldoc iedit helm-spotify helm-projectile helm-org-rifle helm-emmet helm-descbinds groovy-mode fic-mode exec-path-from-shell ess edit-server edit-indirect dirtree darktooth-theme csharp-mode cql-mode company-tern company-racer company-quickhelp company-jedi company-irony-c-headers company-irony company-go company-auctex centered-cursor-mode arduino-mode ace-window ace-jump-mode)))
;;  '(python-shell-interpreter "python3")
;;  '(vc-annotate-background nil)
;;  '(vc-annotate-background-mode nil)
;;  '(vc-annotate-very-old-color nil)
;;  '(warning-suppress-types (quote ((yasnippet backquote-change) (:warning))))
;;  '(yas-indent-line (quote fixed)))
;; (custom-set-faces
;;  ;; custom-set-faces was added by Custom.
;;  ;; If you edit it by hand, you could mess it up, so be careful.
;;  ;; Your init file should contain only one such instance.
;;  ;; If there is more than one, they won't work right.
;;  '(default ((t (:inherit nil :stipple nil :inverse-video nil :box nil :strike-through nil :overline nil :underline nil :slant normal :weight normal :height 90 :width normal :foundry "PfEd" :family "DejaVu Sans Mono"))))
;;  '(fic-author-face ((t (:foreground "dark violet" :underline t))))
;;  '(fic-face ((t (:foreground "magenta" :weight bold))))
;;  ;; '(org-block ((t (:background "#002d39")))) ;; HACK: this is in case we want to change the background-color; though should probably make a custom-theme instead
;;  '(org-block-begin-line ((t (:inherit org-meta-line :underline nil))))
;;  '(org-block-end-line ((t (:inherit org-meta-line :overline nil :slant normal :weight bold))))
;;  '(org-document-title ((t (:inherit default :weight bold :foreground "#ABB2BF" :family "Sans Serif" :height 1.5 :underline nil))))
;;  '(org-level-1 ((t (:inherit default :weight bold :foreground "#ABB2BF" :family "Sans Serif" :height 1.75))))
;;  '(org-level-2 ((t (:inherit default :weight bold :foreground "#ABB2BF" :family "Sans Serif" :height 1.5))))
;;  '(org-level-3 ((t (:inherit default :weight bold :foreground "#ABB2BF" :family "Sans Serif" :height 1.25))))
;;  '(org-level-4 ((t (:inherit default :weight bold :foreground "#ABB2BF" :family "Sans Serif" :height 1.1))))
;;  '(org-level-5 ((t (:inherit default :weight bold :foreground "#ABB2BF" :family "Sans Serif"))))
;;  '(org-level-6 ((t (:inherit default :weight bold :foreground "#ABB2BF" :family "Sans Serif"))))
;;  '(org-level-7 ((t (:inherit default :weight bold :foreground "#ABB2BF" :family "Sans Serif"))))
;;  '(org-level-8 ((t (:inherit default :weight bold :foreground "#ABB2BF" :family "Sans Serif"))))
;;  '(org-meta-line ((t (:foreground "#586e75" :slant normal :weight bold)))))
;; (put 'narrow-to-region 'disabled nil)

(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(bmkp-last-as-first-bookmark-file "~/.emacs.d/bookmarks")
 '(custom-enabled-themes '(solarized-dark))
 '(custom-safe-themes
   '("0598c6a29e13e7112cfbc2f523e31927ab7dce56ebb2016b567e1eff6dc1fd4f" default)))
(custom-set-faces
 ;; custom-set-faces was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 )

#+end_src

#+RESULTS:
